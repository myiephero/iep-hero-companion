import{j as e}from"./chunk-DsWtD-um.js";import{M as s,C as a,P as t}from"./chunk-CQUO3auH.js";import{a as r,B as l,C as i,L as n,I as c,u as d,c as o,r as m,t as x,v as h,w as u,x as g}from"../assets/index-4xq_U8Za.js";import{S as p}from"./chunk-BzrD7sQf.js";import{a as v}from"./chunk-Cxh3gN0V.js";import{D as j,e as f,a as b,b as y,c as N}from"./chunk-DtPYXc3G.js";import{r as w,u as k}from"./chunk--CdJ9rTh.js";import{B as C}from"./chunk-dWvI_tCU.js";import{A as $,b as S,a as F}from"./chunk-XC33JK1E.js";import{b as A,c as I,d as E,a as L,u as _}from"./chunk-CTY4YnfY.js";import{u as M,a as T,b as P,c as z,d as B,e as D,f as R,g as U,M as H,h as O,i as Y,j as q}from"./chunk-BRMrttTJ.js";import{T as G}from"./chunk-B7FVtem3.js";import{ay as J,v as K,ac as V,az as W,as as Q,aA as X,au as Z,av as ee,X as se,M as ae,aB as te,w as re,aC as le,b as ie,aD as ne,ap as ce,U as de,Y as oe,f as me,aE as xe,aF as he}from"./chunk-CIO6T0Sb.js";import{C as ue}from"./chunk-hkvjQ0i3.js";import{S as ge,a as pe,b as ve,c as je,d as fe}from"./chunk-C503eIeV.js";import{C as be,a as ye,b as Ne}from"./chunk-3lxlifzP.js";import"./chunk-DiCKXT8z.js";import"./chunk--P05M-BP.js";import"./chunk-Csgv8Z6q.js";import"./chunk-CeDn3LK_.js";import"./chunk-OMBrO3Ds.js";const we=["#EF4444","#F97316","#F59E0B","#EAB308","#84CC16","#22C55E","#10B981","#14B8A6","#06B6D4","#0EA5E9","#3B82F6","#6366F1","#8B5CF6","#A855F7","#D946EF","#EC4899","#F43F5E","#64748B","#6B7280","#374151"];function ke(){const[s,a]=w.useState(!1),[t,d]=w.useState(null),[o,m]=w.useState(!1),[x,h]=w.useState({name:"",color:we[0],description:""}),{toast:u}=r(),{labels:g,loading:p,error:v,refetch:k}=M(),{create:$,creating:S}=T(),{update:F,updating:A}=P(),{delete:I,deleting:E}=z(),L=()=>{h({name:"",color:we[0],description:""}),d(null),m(!1)};return e.jsxs(j,{open:s,onOpenChange:a,children:[e.jsx(f,{asChild:!0,children:e.jsxs(l,{variant:"outline",size:"sm","data-testid":"button-manage-labels",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Manage Labels"]})}),e.jsxs(b,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsx(y,{children:e.jsx(N,{children:"Manage Conversation Labels"})}),e.jsxs("div",{className:"space-y-4",children:[o&&e.jsx(i,{className:"p-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-medium",children:t?"Edit Label":"Create New Label"}),e.jsx(l,{variant:"ghost",size:"sm",onClick:L,"data-testid":"button-cancel-label-form",children:"Cancel"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"label-name",children:"Name"}),e.jsx(c,{id:"label-name",value:x.name,onChange:e=>h(s=>({...s,name:e.target.value})),placeholder:"Enter label name","data-testid":"input-label-name"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"label-color",children:"Color"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:we.map(s=>e.jsx("button",{type:"button",className:"w-6 h-6 rounded-full border-2 transition-all "+(x.color===s?"border-gray-800 scale-110":"border-gray-300"),style:{backgroundColor:s},onClick:()=>h(e=>({...e,color:s})),"data-testid":`color-option-${s}`},s))})]})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"label-description",children:"Description (Optional)"}),e.jsx(G,{id:"label-description",value:x.description,onChange:e=>h(s=>({...s,description:e.target.value})),placeholder:"Describe when to use this label",rows:2,"data-testid":"textarea-label-description"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{onClick:async()=>{if(x.name.trim())try{t?(await F(t.id,{name:x.name.trim(),color:x.color,description:x.description.trim()||void 0}),u({title:"Label updated",description:"The label has been updated successfully."})):(await $({name:x.name.trim(),color:x.color,description:x.description.trim()||void 0}),u({title:"Label created",description:"New label has been created successfully."})),L(),k()}catch(e){u({title:"Error",description:t?"Failed to update label.":"Failed to create label.",variant:"destructive"})}else u({title:"Name required",description:"Please enter a label name.",variant:"destructive"})},disabled:S||A,"data-testid":"button-save-label",children:[(S||A)&&e.jsx(K,{className:"w-4 h-4 mr-2 animate-spin"}),t?"Update Label":"Create Label"]}),e.jsx(l,{variant:"outline",onClick:L,"data-testid":"button-cancel-save",children:"Cancel"})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-medium",children:"Your Labels"}),!o&&e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>{L(),m(!0)},"data-testid":"button-add-new-label",children:[e.jsx(V,{className:"w-4 h-4 mr-2"}),"Add New Label"]})]}),p?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(K,{className:"w-6 h-6 animate-spin"})}):v?e.jsxs("div",{className:"p-4 text-center text-red-500",children:["Error loading labels: ",v]}):g.length>0?e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:g.map(s=>e.jsx(i,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(C,{style:{backgroundColor:s.color,color:"#ffffff",borderColor:s.color},"data-testid":`label-badge-${s.id}`,children:s.name}),s.description&&e.jsx("span",{className:"text-sm text-muted-foreground",children:s.description}),s.is_default&&e.jsx(C,{variant:"secondary",className:"text-xs",children:"Default"})]}),!s.is_default&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>(e=>{e.is_default?u({title:"Cannot edit default label",description:"Default labels cannot be modified.",variant:"destructive"}):(d(e),h({name:e.name,color:e.color,description:e.description||""}),m(!0))})(s),"data-testid":`button-edit-label-${s.id}`,children:e.jsx(W,{className:"w-4 h-4"})}),e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>(async(e,s)=>{if(confirm(`Are you sure you want to delete the label "${s}"? This action cannot be undone.`))try{await I(e),u({title:"Label deleted",description:"The label has been deleted successfully."}),k()}catch(a){u({title:"Error",description:"Failed to delete label.",variant:"destructive"})}})(s.id,s.name),disabled:E,"data-testid":`button-delete-label-${s.id}`,children:e.jsx(Q,{className:"w-4 h-4 text-red-500"})})]})]})},s.id))}):e.jsxs("div",{className:"p-8 text-center text-muted-foreground",children:[e.jsx(J,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No labels created yet"}),e.jsx("p",{className:"text-sm",children:"Create your first label to organize conversations"})]})]})]})]})]})}const Ce=[{value:"active",label:"Active",icon:ae},{value:"archived",label:"Archived",icon:te},{value:"closed",label:"Closed",icon:se}],$e=[{value:"low",label:"Low",icon:ee},{value:"normal",label:"Normal",icon:ae},{value:"high",label:"High",icon:Z},{value:"urgent",label:"Urgent",icon:re}];function Se({filters:s,onFiltersChange:a,conversationCount:t=0,className:r=""}){const[c,d]=w.useState(!1),{labels:o,loading:m}=M(),x=w.useMemo(()=>{let e=0;return s.status.length>0&&e++,s.priority.length>0&&e++,null!==s.archived&&e++,s.labels.length>0&&e++,e},[s]),h=x>0;return e.jsx(i,{className:`p-4 ${r}`,children:e.jsxs(be,{open:c,onOpenChange:d,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ye,{asChild:!0,children:e.jsxs(l,{variant:"ghost",className:"p-0 font-medium","data-testid":"button-toggle-filters",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Filters",h&&e.jsx(C,{variant:"secondary",className:"ml-2 text-xs","data-testid":"badge-active-filters",children:x}),c?e.jsx(Z,{className:"w-4 h-4 ml-2"}):e.jsx(ee,{className:"w-4 h-4 ml-2"})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[h&&e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>{a({status:[],priority:[],archived:null,labels:[]})},"data-testid":"button-clear-filters",children:[e.jsx(se,{className:"w-4 h-4 mr-1"}),"Clear"]}),e.jsxs("span",{className:"text-sm text-muted-foreground","data-testid":"text-conversation-count",children:[t," conversations"]})]})]}),e.jsxs(Ne,{className:"mt-4",children:[e.jsxs("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:"Archive Status"}),e.jsxs(ge,{value:null===s.archived?"all":s.archived?"archived":"active",onValueChange:e=>{const t="all"===e?null:"archived"===e;a({...s,archived:t})},children:[e.jsx(pe,{"data-testid":"select-archive-status",children:e.jsx(ve,{placeholder:"All conversations"})}),e.jsxs(je,{children:[e.jsx(fe,{value:"all",children:"All conversations"}),e.jsx(fe,{value:"active",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"Active only"]})}),e.jsx(fe,{value:"archived",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"Archived only"]})})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:"Status"}),e.jsx("div",{className:"space-y-2",children:Ce.map(t=>{const r=t.icon;return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ue,{id:`status-${t.value}`,checked:s.status.includes(t.value),onCheckedChange:e=>((e,t)=>{const r=t?[...s.status,e]:s.status.filter(s=>s!==e);a({...s,status:r})})(t.value,e),"data-testid":`checkbox-status-${t.value}`}),e.jsxs(n,{htmlFor:`status-${t.value}`,className:"flex items-center text-sm font-normal cursor-pointer",children:[e.jsx(r,{className:"w-3 h-3 mr-1"}),t.label]})]},t.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:"Priority"}),e.jsx("div",{className:"space-y-2",children:$e.map(t=>{const r=t.icon;return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ue,{id:`priority-${t.value}`,checked:s.priority.includes(t.value),onCheckedChange:e=>((e,t)=>{const r=t?[...s.priority,e]:s.priority.filter(s=>s!==e);a({...s,priority:r})})(t.value,e),"data-testid":`checkbox-priority-${t.value}`}),e.jsxs(n,{htmlFor:`priority-${t.value}`,className:"flex items-center text-sm font-normal cursor-pointer",children:[e.jsx(r,{className:"w-3 h-3 mr-1 "+("urgent"===t.value?"text-red-500":"high"===t.value?"text-orange-500":"low"===t.value?"text-gray-500":"text-blue-500")}),t.label]})]},t.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:"Labels"}),m?e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading labels..."}):o.length>0?e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:o.map(t=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ue,{id:`label-${t.id}`,checked:s.labels.includes(t.id),onCheckedChange:e=>((e,t)=>{const r=t?[...s.labels,e]:s.labels.filter(s=>s!==e);a({...s,labels:r})})(t.id,e),"data-testid":`checkbox-label-${t.id}`}),e.jsxs(n,{htmlFor:`label-${t.id}`,className:"flex items-center text-sm font-normal cursor-pointer",children:[e.jsx("div",{className:"w-3 h-3 rounded-full mr-2",style:{backgroundColor:t.color}}),t.name]})]},t.id))}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No labels available"})]})]}),h&&e.jsxs("div",{className:"mt-4 pt-4 border-t",children:[e.jsx(n,{className:"text-sm font-medium mb-2 block",children:"Active Filters:"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[null!==s.archived&&e.jsx(C,{variant:"secondary","data-testid":"filter-badge-archived",children:s.archived?"Archived":"Active"}),s.status.map(s=>e.jsxs(C,{variant:"secondary","data-testid":`filter-badge-status-${s}`,children:["Status: ",s]},s)),s.priority.map(s=>e.jsxs(C,{variant:"secondary","data-testid":`filter-badge-priority-${s}`,children:["Priority: ",s]},s)),s.labels.map(s=>{const a=o.find(e=>e.id===s);return a?e.jsx(C,{style:{backgroundColor:a.color,color:"#ffffff"},"data-testid":`filter-badge-label-${s}`,children:a.name},s):null})]})]})]})]})})}function Fe({conversationId:s,trigger:a,onLabelsChanged:t}){const[i,c]=w.useState(!1),[d,o]=w.useState([]),[m,x]=w.useState([]),{toast:h}=r(),{labels:u,loading:g}=M(),{labels:p,loading:v,refetch:k}=B(s),{assign:$,assigning:S}=D(),F=w.useMemo(()=>p?p.map(e=>e.id).sort():[],[JSON.stringify(p?.map(e=>e.id).sort()||[])]);w.useEffect(()=>{o(F),x(F)},[F]);const A=JSON.stringify(d.sort())!==JSON.stringify(m.sort());return e.jsxs(j,{open:i,onOpenChange:c,children:[e.jsx(f,{asChild:!0,children:a||e.jsxs(l,{variant:"outline",size:"sm","data-testid":"button-manage-conversation-labels",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Labels",p&&p.length>0&&e.jsx(C,{variant:"secondary",className:"ml-2 text-xs",children:p.length})]})}),e.jsxs(b,{className:"max-w-md",children:[e.jsx(y,{children:e.jsx(N,{children:"Manage Conversation Labels"})}),e.jsxs("div",{className:"space-y-4",children:[p&&p.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:"Current Labels:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:p.map(s=>e.jsx(C,{style:{backgroundColor:s.color,color:"#ffffff",borderColor:s.color},"data-testid":`current-label-${s.id}`,children:s.name},s.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm font-medium",children:"Available Labels:"}),g||v?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(K,{className:"w-6 h-6 animate-spin"})}):u.length>0?e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto border rounded-md p-3",children:u.map(s=>e.jsxs("div",{className:"flex items-center space-x-3 p-2 rounded hover:bg-muted/50",children:[e.jsx(ue,{id:`select-label-${s.id}`,checked:d.includes(s.id),onCheckedChange:e=>((e,s)=>{o(a=>s?[...a,e]:a.filter(s=>s!==e))})(s.id,e),"data-testid":`checkbox-select-label-${s.id}`}),e.jsxs(n,{htmlFor:`select-label-${s.id}`,className:"flex items-center flex-1 cursor-pointer",children:[e.jsx("div",{className:"w-4 h-4 rounded-full mr-2",style:{backgroundColor:s.color}}),e.jsx("span",{className:"flex-1",children:s.name}),s.is_default&&e.jsx(C,{variant:"outline",className:"text-xs ml-2",children:"Default"})]})]},s.id))}):e.jsxs("div",{className:"p-8 text-center text-muted-foreground",children:[e.jsx(J,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No labels available"}),e.jsx("p",{className:"text-sm",children:"Create some labels first to organize your conversations"})]})]}),e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsx(l,{variant:"outline",onClick:()=>{o(m),c(!1)},"data-testid":"button-cancel-label-selection",children:"Cancel"}),e.jsxs(l,{onClick:async()=>{try{await $(s,d),h({title:"Labels updated",description:"Conversation labels have been updated successfully."}),k(),t?.(),c(!1),x(d)}catch(e){h({title:"Error",description:"Failed to update conversation labels.",variant:"destructive"})}},disabled:!A||S,"data-testid":"button-save-label-selection",children:[S&&e.jsx(K,{className:"w-4 h-4 mr-2 animate-spin"}),"Save Changes"]})]}),d.length>0&&A&&e.jsxs("div",{className:"space-y-2 pt-4 border-t",children:[e.jsx(n,{className:"text-sm font-medium",children:"Selected Labels:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.map(s=>{const a=u.find(e=>e.id===s);return a?e.jsx(C,{style:{backgroundColor:a.color,color:"#ffffff",borderColor:a.color},"data-testid":`selected-label-${s}`,children:a.name},s):null})})]})]})]})]})}const Ae={introduction:{title:"Professional Introduction",icon:de,template:(e,s)=>`Hello! Thank you for considering me as an advocate for ${e}${s}. I received your match proposal and I'm excited about the opportunity to support your family.\n\nI'd love to learn more about ${e}'s specific needs, current IEP goals, and how I can best advocate for their educational success. Would you be available for a brief introductory call this week to discuss your priorities and next steps?\n\nI look forward to hearing from you and hopefully working together to ensure ${e} receives the support they deserve.\n\nBest regards,\nProfessional Advocate`},urgent_response:{title:"Urgent Support Response",icon:oe,template:(e,s)=>`Hello! I received your match proposal for ${e}${s} and understand there may be urgent advocacy needs.\n\nI specialize in expedited IEP support and can typically begin advocacy services within 24-48 hours. I'm immediately available for an emergency consultation to discuss ${e}'s situation and develop an action plan.\n\nPlease let me know your availability for a priority call today or tomorrow. Time is critical, and I'm committed to ensuring ${e} receives the support they need without delay.\n\nUrgent regards,\nProfessional Advocate`},detailed_inquiry:{title:"Comprehensive Assessment",icon:me,template:(e,s)=>`Hello! Thank you for your interest in advocacy services for ${e}${s}. I'm honored to be considered for this important role.\n\nTo provide the most effective advocacy support, I'd like to understand:\n• ${e}'s current IEP goals and any areas of concern\n• Recent evaluation results or upcoming assessments\n• Specific challenges you've encountered with the school district\n• Your primary advocacy priorities and timeline\n\nI offer a complimentary 30-minute consultation to review ${e}'s educational profile and discuss how I can best support your family's advocacy goals. Would you prefer a phone or video call this week?\n\nProfessionally yours,\nProfessional Advocate`}};function Ie({conversation:s}){const{updateStatus:a}=R(),{toast:t}=r(),i=async e=>{try{await a(s.id,{priority:e}),t({title:"Priority updated",description:`Conversation priority set to ${e}.`})}catch(r){t({title:"Error",description:"Failed to update conversation priority.",variant:"destructive"})}};return e.jsxs(m,{children:[e.jsx(x,{asChild:!0,children:e.jsx(l,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0","data-testid":`conversation-menu-${s.id}`,children:e.jsx(xe,{className:"h-4 w-4"})})}),e.jsxs(h,{align:"end",children:[e.jsx(u,{onClick:async()=>{try{await a(s.id,{archived:!s.archived}),t({title:s.archived?"Conversation unarchived":"Conversation archived",description:s.archived?"Conversation moved back to active conversations.":"Conversation moved to archived conversations."})}catch(e){t({title:"Error",description:"Failed to update conversation status.",variant:"destructive"})}},"data-testid":`conversation-${s.archived?"unarchive":"archive"}-${s.id}`,children:s.archived?e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"mr-2 h-4 w-4"}),"Unarchive"]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),"Archive"]})}),e.jsx(g,{}),e.jsxs(u,{onClick:()=>i("urgent"),"data-testid":`conversation-priority-urgent-${s.id}`,children:[e.jsx(re,{className:"mr-2 h-4 w-4 text-red-500"}),"Mark as Urgent"]}),e.jsxs(u,{onClick:()=>i("high"),"data-testid":`conversation-priority-high-${s.id}`,children:[e.jsx(Z,{className:"mr-2 h-4 w-4 text-orange-500"}),"Mark as High Priority"]}),e.jsxs(u,{onClick:()=>i("normal"),"data-testid":`conversation-priority-normal-${s.id}`,children:[e.jsx(ae,{className:"mr-2 h-4 w-4"}),"Mark as Normal"]}),e.jsxs(u,{onClick:()=>i("low"),"data-testid":`conversation-priority-low-${s.id}`,children:[e.jsx(Z,{className:"mr-2 h-4 w-4 text-gray-500 rotate-180"}),"Mark as Low Priority"]})]})]})}function Ee({conversationId:s}){const{labels:a,loading:t}=B(s);return t||!a||0===a.length?null:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[a.slice(0,3).map(a=>e.jsx(C,{style:{backgroundColor:a.color,color:"#ffffff",borderColor:a.color},className:"text-xs px-1 py-0 h-5","data-testid":`conversation-label-${s}-${a.id}`,children:a.name},a.id)),a.length>3&&e.jsxs(C,{variant:"outline",className:"text-xs px-1 py-0 h-5",children:["+",a.length-3]})]})}function Le(){const{user:i,loading:n,isAuthenticated:m}=d(),x=k(),[h,u]=w.useState(null),[g,j]=w.useState(""),[f,b]=w.useState(null),[y,N]=w.useState(!1),[M,T]=w.useState([]),[P,z]=w.useState(!1),[B,D]=w.useState(!0),[G,J]=w.useState({status:[],priority:[],archived:null,labels:[]});r(),R();const{conversations:V,loading:W,error:Q,refetch:X}=A({},m),{contacts:Z,loading:ee,error:de,refetch:oe}=I(m),{messageHistory:me,loading:xe,refetch:he}=E(h?.id||null,m),{send:ue,sending:ge}=L(),{create:pe,creating:ve}=_(),{searchTerm:je,setSearchTerm:fe,currentResultIndex:be,totalResults:ye,goToNext:Ne,goToPrevious:we,clearSearch:Ce,isCurrentResult:$e,hasActiveSearch:Le,hasResults:_e,currentSearchResult:Me}=U(me?.messages||[]),Te=w.useRef(null),Pe=w.useMemo(()=>V.length?V.filter(e=>{if(null!==G.archived){if(G.archived&&!e.archived)return!1;if(!G.archived&&e.archived)return!1}return!(G.status.length>0&&!G.status.includes(e.status||"active"))&&!(G.priority.length>0&&!G.priority.includes(e.priority||"normal"))}):[],[V,G]);w.useEffect(()=>{if(V.length>0){const e=new URLSearchParams(x.search),s=e.get("parent"),a=e.get("student");if(s&&a){const e=V.find(e=>e.parent_id===s&&e.student_id===a);e&&h?.id!==e.id&&u(e)}}},[V,x.search,h?.id]),w.useEffect(()=>{if(x.state?.newMessage&&!ve){const{advocateId:e,studentId:s,studentName:a,proposalId:t,studentGrade:r,studentSchool:l}=x.state.newMessage,i=r?` (currently in grade ${r}`:"",n=l?` at ${l}`:"",c=i||n?`${i}${n}${i?")":""}`:"";N(!0);const d=a||"your child",o=Ae.introduction.template(d,c);j(o),b("introduction");const m=x.state.newMessage.parentId;m&&pe(e,s,m).then(e=>{e&&(u(e),X())})}},[x.state,pe,ve,X]),w.useEffect(()=>{if(Me&&Te.current){const e=Te.current.querySelector(`[data-message-id="${Me.message.id}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}},[Me]);const ze=async()=>{if(!h||ge)return;const e=g.trim(),s=M.some(e=>"completed"===e.status&&e.documentId);if(!e&&!s)return;if(M.some(e=>"uploading"===e.status))return void console.warn("Some files are still uploading. Please wait for uploads to complete.");const a=M.filter(e=>"completed"===e.status&&e.documentId).map(e=>e.documentId);try{await ue(h.id,g.trim()||void 0,a.length>0?a:void 0)&&(j(""),T([]),z(!1),b(null),N(!1),he(),X())}catch(t){console.error("Error sending message:",t)}};return n?e.jsx(s,{showBottomNav:!0,children:e.jsxs(p,{children:[e.jsx(v,{title:"Messages"}),e.jsx(a,{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 text-center",children:[e.jsx(K,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading..."})]})})]})}):m&&i?e.jsx(s,{showBottomNav:!0,children:e.jsxs(p,{children:[e.jsx(v,{title:h&&!B?`${h.student?.full_name||"Student"}'s Family`:"Messages",subtitle:h&&!B?`Advocate: ${h.advocate?.name||"Unknown"}`:`${Pe.length} conversation${1!==Pe.length?"s":""}`,showBack:h&&!B,onBack:()=>{u(null),D(!0)},rightAction:h&&!B&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{conversationId:h.id,onLabelsChanged:()=>{X()}}),e.jsx(Ie,{conversation:h})]})}),e.jsxs(a,{className:"flex-1 overflow-hidden",children:[B&&e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx(t,{variant:"glass",className:"p-4 mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(le,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5"}),e.jsx(c,{placeholder:"Search conversations...",className:"pl-12 h-12 text-base bg-white/50 dark:bg-gray-900/50 border-gray-200/50 dark:border-gray-700/50 backdrop-blur-sm"})]})}),e.jsxs(t,{variant:"elevated",className:"p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(ke,{}),e.jsxs("div",{className:"flex items-center gap-1 px-3 py-1 bg-blue-50 dark:bg-blue-950 rounded-full",children:[e.jsx(ie,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"text-sm font-medium text-blue-700 dark:text-blue-300",children:Pe.length})]})]}),e.jsx(Se,{filters:G,onFiltersChange:J,conversationCount:Pe.length})]}),W?e.jsx(t,{variant:"glass",className:"p-8",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{className:"h-6 w-6 animate-spin text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"text-base text-gray-600 dark:text-gray-400",children:"Loading conversations..."})]})})}):Q?e.jsx(t,{variant:"elevated",className:"p-6",children:e.jsxs("div",{className:"text-center text-red-500",children:["Error loading conversations: ",Q]})}):e.jsxs(e.Fragment,{children:[Pe.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 px-2",children:[e.jsx("div",{className:"h-1 w-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider",children:"Active Conversations"})]}),e.jsx("div",{className:"space-y-3",children:Pe.map(s=>e.jsx(t,{variant:"interactive",onClick:()=>(e=>{u(e),D(!1)})(s),className:o("p-4 transition-all duration-200",h?.id===s.id&&"ring-2 ring-blue-500 dark:ring-blue-400"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs($,{className:"h-12 w-12",children:[e.jsx(S,{src:"/placeholder-1.jpg"}),e.jsx(F,{className:"bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950 dark:to-blue-900 text-blue-600 dark:text-blue-400 font-semibold",children:s.student?.full_name?s.student.full_name.split(" ").map(e=>e[0]).join(""):"S"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:"text-base font-semibold text-gray-900 dark:text-gray-100 truncate",children:s.student?.full_name?`${s.student.full_name}'s Family`:"Student's Family"}),e.jsxs("div",{className:"flex items-center gap-1",children:[s.archived&&e.jsxs(C,{variant:"secondary",className:"text-xs px-2 py-1",children:[e.jsx(te,{className:"w-3 h-3 mr-1"}),"Archived"]}),"urgent"===s.priority&&e.jsxs(C,{variant:"destructive",className:"text-xs px-2 py-1",children:[e.jsx(re,{className:"w-3 h-3 mr-1"}),"Urgent"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:s.last_message_at?new Date(s.last_message_at).toLocaleDateString():"No messages yet"}),e.jsx(Ee,{conversationId:s.id})]})]})]})},s.id))})]}),Z&&Z.filter(e=>!e.hasConversation).length>0&&e.jsxs("div",{className:"space-y-3 mt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 px-2",children:[e.jsx("div",{className:"h-1 w-8 bg-gradient-to-r from-green-500 to-green-600 rounded-full"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider",children:"New Contacts"}),e.jsxs(C,{variant:"secondary",className:"ml-auto",children:[Z.filter(e=>!e.hasConversation).length," new"]})]}),e.jsx("div",{className:"space-y-3",children:Z.filter(e=>!e.hasConversation).map(s=>{const a=s.student?.full_name||"Unknown Student",r=a.split(" ").map(e=>e[0]).join(""),l="inactive"===s.contactType?"Pending proposal":"Accepted proposal";return e.jsx(t,{variant:"interactive",onClick:()=>(async e=>{try{const s=await pe(e.proposal.advocate_id,e.proposal.student_id,e.proposal.parent_id);if(s){await X(),u(s);const a=e.student?.full_name||"your child",t=Ae.introduction.template(a,"");j(t),b("introduction"),N(!0)}}catch(s){console.error("Error creating conversation:",s)}})(s),className:"p-4 bg-gradient-to-r from-green-50/50 to-green-100/50 dark:from-green-950/20 dark:to-green-900/20 border-green-200/50 dark:border-green-800/50","data-testid":`proposal-contact-${s.proposal.id}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs($,{className:"h-12 w-12 ring-2 ring-green-200 dark:ring-green-800",children:[e.jsx(S,{src:"/placeholder-new.jpg"}),e.jsx(F,{className:"bg-gradient-to-br from-green-50 to-green-100 dark:from-green-950 dark:to-green-900 text-green-600 dark:text-green-400 font-semibold",children:r})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("p",{className:"text-base font-semibold text-gray-900 dark:text-gray-100 truncate",children:[a,"'s Family"]}),e.jsx(C,{variant:"inactive"===s.contactType?"secondary":"outline",className:"text-xs px-2 py-1 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border-green-300 dark:border-green-700",children:"inactive"===s.contactType?"New":"Ready"})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:l}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4 text-green-600 dark:text-green-400"}),e.jsx("p",{className:"text-sm font-medium text-green-600 dark:text-green-400",children:"Click to start messaging"})]})]})]})},s.proposal.id)})})]}),0===Pe.length&&V.length>0&&e.jsx(t,{variant:"glass",className:"p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950 dark:to-blue-900 rounded-2xl flex items-center justify-center",children:e.jsx(ae,{className:"h-8 w-8 text-blue-600 dark:text-blue-400"})}),e.jsx("p",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2",children:"No matches found"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Try adjusting your filter criteria"})]})}),0===V.length&&(!Z||0===Z.length)&&e.jsx(t,{variant:"glass",className:"p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950 dark:to-blue-900 rounded-3xl flex items-center justify-center",children:e.jsx(ae,{className:"h-10 w-10 text-blue-600 dark:text-blue-400"})}),e.jsx("p",{className:"text-xl font-bold text-gray-900 dark:text-gray-100 mb-3",children:"No Conversations Yet"}),e.jsx("p",{className:"text-base text-gray-600 dark:text-gray-400 leading-relaxed",children:"Your client messages will appear here once you start receiving communications."})]})})]})]}),h&&!B&&e.jsxs("div",{className:"h-full flex flex-col",children:[me?.messages&&me.messages.length>0&&e.jsx("div",{className:"mb-4",children:e.jsx(H,{searchTerm:je,onSearchChange:fe,currentResult:be,totalResults:ye,onNext:Ne,onPrevious:we,onClear:Ce,placeholder:"Search conversation messages..."})}),e.jsx(t,{variant:"glass",className:"flex-1 p-4 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-y-auto space-y-4 scroll-smooth",ref:Te,children:xe?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{className:"h-6 w-6 animate-spin text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"text-base text-gray-600 dark:text-gray-400",children:"Loading messages..."})]})}):me?.messages&&me.messages.length>0?me.messages.map(s=>e.jsx("div",{className:"flex "+(s.sender_id===h.advocate_id?"justify-end":"justify-start"),"data-testid":`message-${s.id}`,"data-message-id":s.id,children:e.jsxs("div",{className:o("max-w-[85%] p-4 rounded-2xl shadow-sm transition-all duration-200",s.sender_id===h.advocate_id?"bg-gradient-to-br from-blue-500 to-blue-600 text-white ml-12":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 mr-12"),children:[s.content&&e.jsx("p",{className:"text-sm leading-relaxed",children:e.jsx(O,{text:s.content,searchTerm:je,isCurrentResult:$e(s.id),className:"break-words"})}),s.attachments&&s.attachments.length>0&&e.jsx(Y,{attachments:s.attachments,compact:!0}),e.jsx("span",{className:o("text-xs block mt-2",s.sender_id===h.advocate_id?"text-blue-100":"text-gray-500 dark:text-gray-400"),children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},s.id)):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950 dark:to-blue-900 rounded-2xl flex items-center justify-center",children:e.jsx(ae,{className:"h-8 w-8 text-blue-600 dark:text-blue-400"})}),e.jsx("p",{className:"text-xl font-bold text-gray-900 dark:text-gray-100 mb-3",children:"No Messages Yet"}),e.jsxs("p",{className:"text-base text-gray-600 dark:text-gray-400",children:["Start a conversation with ",h.student?.full_name||"the student","'s family"]})]})})})}),e.jsxs("div",{className:"mt-4 space-y-4",children:[y&&x.state?.newMessage&&e.jsxs(t,{variant:"glass",className:"p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-950 dark:to-purple-900 rounded-xl flex items-center justify-center",children:e.jsx(ie,{className:"h-4 w-4 text-purple-600 dark:text-purple-400"})}),e.jsx("h4",{className:"text-lg font-bold text-gray-900 dark:text-gray-100",children:"Professional Templates"})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Choose a template to personalize your response"})]}),e.jsxs("div",{className:"flex flex-col gap-3",children:[Object.entries(Ae).map(([s,a])=>{const t=a.icon,r=f===s;return e.jsx(l,{variant:"ghost",onClick:()=>(e=>{if(x.state?.newMessage){const{studentName:s,studentGrade:a,studentSchool:t}=x.state.newMessage,r=a?` (currently in grade ${a}`:"",l=t?` at ${t}`:"",i=r||l?`${r}${l}${r?")":""}`:"",n=Ae[e];if(n){const a=s||"your child";j(n.template(a,i)),b(e)}}})(s),className:o("h-auto p-4 justify-start text-left transition-all duration-200",r?"bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-950 dark:to-blue-900 border-2 border-blue-200 dark:border-blue-800":"hover:bg-gray-50 dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700"),"data-testid":`template-${s}`,children:e.jsxs("div",{className:"flex items-center gap-3 w-full",children:[e.jsx("div",{className:o("w-10 h-10 rounded-xl flex items-center justify-center",r?"bg-blue-500 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"),children:e.jsx(t,{className:"h-5 w-5"})}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:o("font-semibold",r?"text-blue-700 dark:text-blue-300":"text-gray-900 dark:text-gray-100"),children:a.title})})]})},s)}),e.jsxs(l,{variant:"ghost",size:"sm",onClick:()=>N(!1),className:"mt-2 self-end text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Hide Templates"]})]})]}),P&&e.jsxs(t,{variant:"elevated",className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-950 dark:to-green-900 rounded-xl flex items-center justify-center",children:e.jsx(ne,{className:"h-4 w-4 text-green-600 dark:text-green-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:"Attach Files"})]}),e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>{z(!1),T([])},className:"h-8 w-8 p-0 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",children:e.jsx(se,{className:"h-4 w-4"})})]}),e.jsx(q,{files:M,onFilesChange:T,maxFiles:5,disabled:ge})]}),e.jsxs(t,{variant:"elevated",className:"p-4",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>z(!P),className:o("h-12 w-12 rounded-xl transition-all duration-200 mb-1",P?"bg-green-50 dark:bg-green-950 text-green-600 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900":"hover:bg-gray-100 dark:hover:bg-gray-800"),"data-testid":"button-attach-files",children:e.jsx(ne,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("textarea",{placeholder:"Type your message...",className:"w-full min-h-[80px] max-h-[200px] p-4 text-base border border-gray-200 dark:border-gray-700 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-800 transition-all duration-200",value:g,onChange:e=>j(e.target.value),onKeyDown:async e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),(g.trim()||M.some(e=>"completed"===e.status))&&h&&!ge&&await ze())},"data-testid":"input-message"}),M.length>0&&e.jsx("div",{className:"flex items-center gap-2 text-sm",children:e.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-blue-50 dark:bg-blue-950 rounded-lg",children:[e.jsx(ne,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"}),e.jsxs("span",{className:"text-blue-700 dark:text-blue-300 font-medium",children:[M.filter(e=>"completed"===e.status).length," of ",M.length," files ready"]})]})})]}),e.jsx(l,{size:"default",disabled:ge||!g.trim()&&!M.some(e=>"completed"===e.status),onClick:ze,"data-testid":"button-send-message",className:o("h-12 w-12 rounded-xl mb-1 transition-all duration-200",!g.trim()&&!M.some(e=>"completed"===e.status)||ge?"":"bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white shadow-lg hover:shadow-xl"),children:ge?e.jsx(K,{className:"h-5 w-5 animate-spin"}):e.jsx(ce,{className:"h-5 w-5"})})]}),!y&&x.state?.newMessage&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 border-dashed",children:e.jsxs(l,{variant:"ghost",size:"sm",onClick:()=>N(!0),className:"text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Show Professional Templates"]})})]})]})]})]})]})}):e.jsx(s,{showBottomNav:!0,children:e.jsxs(p,{children:[e.jsx(v,{title:"Messages"}),e.jsx(a,{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(t,{variant:"elevated",className:"max-w-md mx-auto p-6",children:e.jsxs("div",{className:"text-center space-y-6",children:[e.jsx(ae,{className:"h-12 w-12 mx-auto text-primary"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-semibold",children:"Authentication Required"}),e.jsx("p",{className:"text-muted-foreground",children:"You need to sign in to access advocate messaging."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{asChild:!0,className:"w-full","data-testid":"button-sign-in",children:e.jsx("a",{href:"/auth",children:"Sign In"})}),e.jsx(l,{variant:"outline",asChild:!0,className:"w-full","data-testid":"button-home",children:e.jsx("a",{href:"/",children:"Go Home"})})]})]})})})]})})}export{Le as default};
