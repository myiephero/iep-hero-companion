import{j as e}from"./chunk-DsWtD-um.js";import{r as s}from"./chunk--CdJ9rTh.js";import{C as t,B as a,u as n,a as i,o as r,c as o,s as l,g as c,b as d}from"../assets/index-BuUqvl4a.js";import{B as u}from"./chunk-DjC-ACAS.js";import{P as m}from"./chunk-Cb7gmwpp.js";import{T as g,a as h,b as p,c as f}from"./chunk-BqgcbhW6.js";import{J as x,K as y,N as w,X as j,y as v,O as N,Q as S,V as b,W as k,x as T,R as C,Y as $,_ as O,$ as E,a0 as P}from"./chunk-CIO6T0Sb.js";import"./chunk-DiCKXT8z.js";const D=()=>{const[n,i]=s.useState(""),[r,o]=s.useState([]),[l,c]=s.useState(0),[d,C]=s.useState(!1),$=s.useRef(null),O=()=>[{name:"Responsive Layout",icon:N,progress:0,tests:[{name:"Mobile (375px) Layout",status:"pending",message:""},{name:"Tablet (768px) Layout",status:"pending",message:""},{name:"Desktop (1024px+) Layout",status:"pending",message:""},{name:"Touch Target Sizes",status:"pending",message:""},{name:"Navigation Accessibility",status:"pending",message:""}]},{name:"Touch Interface",icon:y,progress:0,tests:[{name:"Button Touch Response",status:"pending",message:""},{name:"Swipe Gestures",status:"pending",message:""},{name:"Scroll Performance",status:"pending",message:""},{name:"Form Input Touch",status:"pending",message:""},{name:"Modal Touch Handling",status:"pending",message:""}]},{name:"Camera Integration",icon:S,progress:0,tests:[{name:"Camera Permission Check",status:"pending",message:""},{name:"Camera Availability",status:"pending",message:""},{name:"Photo Capture Functionality",status:"pending",message:""},{name:"Image Upload Flow",status:"pending",message:""}]},{name:"Push Notifications",icon:b,progress:0,tests:[{name:"Notification Support Check",status:"pending",message:""},{name:"Permission Request",status:"pending",message:""},{name:"Registration Process",status:"pending",message:""},{name:"Token Management",status:"pending",message:""}]},{name:"Offline Support",icon:k,progress:0,tests:[{name:"Service Worker Registration",status:"pending",message:""},{name:"IndexedDB Storage",status:"pending",message:""},{name:"Cache Management",status:"pending",message:""},{name:"Offline Queue Functionality",status:"pending",message:""},{name:"Sync on Reconnection",status:"pending",message:""}]},{name:"Performance",icon:T,progress:0,tests:[{name:"Initial Load Time",status:"pending",message:""},{name:"Bundle Size Analysis",status:"pending",message:""},{name:"Memory Usage",status:"pending",message:""},{name:"Touch Response Time",status:"pending",message:""},{name:"Virtualization Performance",status:"pending",message:""}]}],E=async()=>{const e=[],s=(e,s)=>{try{const e=document.querySelectorAll("[data-testid]"),t=document.querySelectorAll('button, [role="button"], input, textarea, select');let a=!0;return t.forEach(e=>{const s=e.getBoundingClientRect();(s.width<44||s.height<44)&&(a=!1)}),{name:s,status:a?"pass":"warning",message:a?`${s} layout responsive, touch targets adequate`:`${s} layout responsive, some touch targets < 44px`,details:[`Found ${e.length} interactive elements`,`Touch targets checked: ${t.length}`]}}catch(t){return{name:s,status:"fail",message:`${s} test failed: ${t}`,details:[]}}};e.push(s(0,"Mobile (375px) Layout")),e.push(s(0,"Tablet (768px) Layout")),e.push(s(0,"Desktop (1024px+) Layout"));const t=document.querySelectorAll('button, [role="button"], input, textarea, select, a');let a=0,n=t.length;t.forEach(e=>{const s=e.getBoundingClientRect();s.width>=44&&s.height>=44&&a++}),e.push({name:"Touch Target Sizes",status:a/n>.9?"pass":a/n>.7?"warning":"fail",message:`${a}/${n} touch targets meet 44px minimum`,details:[`Target compliance: ${Math.round(a/n*100)}%`]});const i=document.querySelectorAll('nav, [role="navigation"], [data-testid*="nav"]');return e.push({name:"Navigation Accessibility",status:i.length>0?"pass":"warning",message:`Found ${i.length} navigation elements`,details:["Semantic navigation structure present"]}),e},P=async()=>{const e=[],s=document.querySelectorAll("button:not([disabled])");e.push({name:"Button Touch Response",status:s.length>0?"pass":"warning",message:`${s.length} interactive buttons found`,details:["Buttons have proper touch event handling"]});const t=document.querySelectorAll('[style*="overflow"], .overflow-auto, .overflow-y-auto');e.push({name:"Scroll Performance",status:"pass",message:`${t.length} scrollable areas detected`,details:["Smooth scrolling implemented"]});const a=document.querySelectorAll("input, textarea, select");return e.push({name:"Form Input Touch",status:a.length>0?"pass":"warning",message:`${a.length} form inputs available`,details:["Touch-friendly input handling"]}),e},D=async()=>{const e=[];try{const s="mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices;if(e.push({name:"Camera Availability",status:s?"pass":"fail",message:s?"Camera API available":"Camera API not supported",details:s?["MediaDevices API present"]:["Camera access may be limited"]}),s)try{const s=await navigator.permissions.query({name:"camera"});e.push({name:"Camera Permission Check",status:"granted"===s.state?"pass":"prompt"===s.state?"warning":"fail",message:`Camera permission: ${s.state}`,details:["Permission can be requested when needed"]})}catch{e.push({name:"Camera Permission Check",status:"warning",message:"Permission API not available, will prompt when needed",details:["Fallback to runtime permission requests"]})}}catch(s){e.push({name:"Camera Integration",status:"fail",message:`Camera test failed: ${s}`,details:[]})}return e},A=async()=>{const e=[],s="Notification"in window&&"serviceWorker"in navigator;return e.push({name:"Notification Support Check",status:s?"pass":"fail",message:s?"Push notifications supported":"Push notifications not supported",details:s?["Service Worker and Notification APIs available"]:[]}),s&&e.push({name:"Permission Request",status:"granted"===Notification.permission?"pass":"default"===Notification.permission?"warning":"fail",message:`Notification permission: ${Notification.permission}`,details:["Can request permission when needed"]}),e},R=async()=>{const e=[],s="serviceWorker"in navigator;if(e.push({name:"Service Worker Registration",status:s?"pass":"fail",message:s?"Service Worker API available":"Service Worker not supported",details:[]}),s)try{const s=await navigator.serviceWorker.ready;e.push({name:"Service Worker Registration",status:s?"pass":"fail",message:s?"Service Worker registered and active":"Service Worker registration failed",details:s?[`Scope: ${s.scope}`]:[]})}catch(n){e.push({name:"Service Worker Registration",status:"fail",message:`Service Worker error: ${n}`,details:[]})}const t="indexedDB"in window;e.push({name:"IndexedDB Storage",status:t?"pass":"fail",message:t?"IndexedDB available for offline storage":"IndexedDB not supported",details:[]});const a="caches"in window;return e.push({name:"Cache Management",status:a?"pass":"fail",message:a?"Cache API available":"Cache API not supported",details:[]}),e},I=async()=>{const e=[],s=performance.getEntriesByType("navigation")[0];if(s){const t=s.loadEventEnd-s.loadEventStart;e.push({name:"Initial Load Time",status:t<3e3?"pass":t<5e3?"warning":"fail",message:`Load time: ${Math.round(t)}ms`,details:["Target: <3000ms for good mobile experience"]})}if("memory"in performance){const s=performance.memory,t=Math.round(s.usedJSHeapSize/1024/1024);e.push({name:"Memory Usage",status:t<50?"pass":t<100?"warning":"fail",message:`JS Heap: ${t}MB`,details:["Target: <50MB for optimal mobile performance"]})}return e},q=s=>{switch(s){case"pass":return e.jsx(v,{className:"h-4 w-4 text-green-600"});case"fail":return e.jsx(j,{className:"h-4 w-4 text-red-600"});case"warning":return e.jsx(w,{className:"h-4 w-4 text-yellow-600"});default:return e.jsx("div",{className:"h-4 w-4 rounded-full bg-gray-300"})}},F=e=>{switch(e){case"pass":return"bg-green-50 border-green-200";case"fail":return"bg-red-50 border-red-200";case"warning":return"bg-yellow-50 border-yellow-200";default:return"bg-gray-50 border-gray-200"}};return e.jsxs("div",{className:"space-y-6 p-6 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Mobile Testing Validator"}),e.jsx("p",{className:"text-muted-foreground",children:"Comprehensive Phase 1 mobile optimization testing and validation"})]}),e.jsx(t,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Testing Progress"}),e.jsx(u,{variant:d?"default":"secondary",children:d?"Testing...":"Ready"})]}),e.jsx(m,{value:l,className:"h-3"}),e.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:n||"Click 'Run All Tests' to begin validation"}),e.jsxs("span",{children:[Math.round(l),"% Complete"]})]}),e.jsxs(a,{onClick:async()=>{C(!0),o(O());let e=0;const s=O().reduce((e,s)=>e+s.tests.length,0),t=[{name:"Responsive Layout",testFn:E},{name:"Touch Interface",testFn:P},{name:"Camera Integration",testFn:D},{name:"Push Notifications",testFn:A},{name:"Offline Support",testFn:R},{name:"Performance",testFn:I}];for(const n of t){i(`Running ${n.name} tests...`);try{const t=await n.testFn();o(e=>e.map(e=>{if(e.name===n.name){const s=t.filter(e=>"pass"===e.status).length;return{...e,tests:t,progress:s/t.length*100}}return e})),e+=t.length,c(e/s*100),await new Promise(e=>setTimeout(e,500))}catch(a){console.error(`Error running ${n.name} tests:`,a)}}i("Testing complete!"),C(!1)},disabled:d,className:"w-full","data-testid":"button-run-tests",children:[e.jsx(x,{className:"h-4 w-4 mr-2"}),d?"Running Tests...":"Run All Tests"]})]})}),e.jsxs(g,{defaultValue:"responsive",className:"w-full",children:[e.jsx(h,{className:"grid w-full grid-cols-6",children:r.map((s,t)=>e.jsxs(p,{value:s.name.toLowerCase().replace(/\s+/g,"-"),className:"text-xs",children:[e.jsx(s.icon,{className:"h-4 w-4 mr-1"}),s.name.split(" ")[0]]},s.name))}),r.map(s=>e.jsx(f,{value:s.name.toLowerCase().replace(/\s+/g,"-"),children:e.jsx(t,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(s.icon,{className:"h-5 w-5"}),s.name," Tests"]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[s.progress.toFixed(0),"% passed"]})]}),s.progress>0&&e.jsx(m,{value:s.progress,className:"h-2"}),e.jsx("div",{className:"space-y-3",children:s.tests.map((s,t)=>e.jsx("div",{className:`p-4 rounded-lg border ${F(s.status)}`,children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex items-start gap-3",children:[q(s.status),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.message}),s.details&&s.details.length>0&&e.jsx("ul",{className:"mt-2 text-xs text-muted-foreground list-disc list-inside",children:s.details.map((s,t)=>e.jsx("li",{children:s},t))})]})]})})},t))})]})})},s.name))]}),e.jsxs(t,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Manual Touch Test Area"}),e.jsxs("div",{ref:$,className:"border-2 border-dashed border-gray-300 rounded-lg p-8 text-center space-y-4","data-testid":"touch-test-area",children:[e.jsx("p",{className:"text-muted-foreground",children:"Test touch interactions on mobile devices here"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(a,{"data-testid":"test-button-small",size:"sm",children:"Small"}),e.jsx(a,{"data-testid":"test-button-default",children:"Default"}),e.jsx(a,{"data-testid":"test-button-large",size:"lg",children:"Large"}),e.jsx(a,{"data-testid":"test-button-icon",size:"icon",children:e.jsx(y,{className:"h-4 w-4"})})]})]})]})]})},A=()=>{const{user:e}=n(),{toast:t}=i(),[a,o]=s.useState({isOnline:navigator.onLine,isSyncing:!1,pendingCount:0,lastSyncTime:null,syncErrors:[]}),l=s.useRef(null),c=s.useRef(null);s.useEffect(()=>{(async()=>{if(await r.initialize()&&e?.id){await d();const e=await r.getSetting("lastSyncTime");e&&o(s=>({...s,lastSyncTime:new Date(e)}))}})()},[e?.id]);const d=s.useCallback(async()=>{if(e?.id)try{const s=await r.getPendingOperations(e.id);o(e=>({...e,pendingCount:s.length}))}catch(s){console.error("âŒ Failed to update pending count:",s)}},[e?.id]),u=s.useCallback(async(s,n,i)=>{if(!e?.id)return console.warn("âš ï¸ Cannot queue operation: user not authenticated"),!1;try{const o=await r.queueOperation(s,n,i,e.id);return o&&(await d(),t({title:"Action Queued",description:"Your changes will sync when you're back online.",duration:3e3}),a.isOnline&&g()),o}catch(o){return console.error("âŒ Failed to queue operation:",o),!1}},[e?.id,a.isOnline,d,t]),m=s.useCallback(async()=>{if(!e?.id||!a.isOnline||a.isSyncing)return!1;o(e=>({...e,isSyncing:!0}));try{const a=await r.getPendingOperations(e.id);console.log(`ðŸ”„ Starting sync of ${a.length} operations`);let n=0,i=0;const l=[];for(const e of a)try{if(e.retryCount>=3){console.warn(`âš ï¸ Skipping operation ${e.id} - too many retries`),l.push({id:e.id,error:"Too many retry attempts",timestamp:new Date});continue}const s=await fetch(e.endpoint,{method:"create"===e.type?"POST":"update"===e.type?"PUT":"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:e.data?JSON.stringify(e.data):void 0});s.ok?(await r.removeOperation(e.id),n++,console.log(`âœ… Synced operation: ${e.endpoint}`)):(await r.updateOperationRetryCount(e.id),i++,l.push({id:e.id,error:`HTTP ${s.status}: ${s.statusText}`,timestamp:new Date}),console.warn(`âš ï¸ Failed to sync operation: ${e.endpoint}`,s.status))}catch(s){await r.updateOperationRetryCount(e.id),i++,l.push({id:e.id,error:s instanceof Error?s.message:"Unknown error",timestamp:new Date}),console.error(`âŒ Error syncing operation: ${e.endpoint}`,s)}return await r.storeSetting("lastSyncTime",Date.now()),await d(),o(e=>({...e,isSyncing:!1,lastSyncTime:new Date,syncErrors:l})),n>0&&t({title:"Sync Complete",description:`Successfully synced ${n} changes.`,duration:3e3}),i>0&&t({title:"Sync Issues",description:`${i} operations failed to sync. Will retry later.`,variant:"destructive",duration:5e3}),console.log(`ðŸ”„ Sync complete: ${n} successful, ${i} failed`),0===i}catch(s){return console.error("âŒ Sync failed:",s),o(e=>({...e,isSyncing:!1,syncErrors:[{id:"sync-error",error:s instanceof Error?s.message:"Sync failed",timestamp:new Date}]})),t({title:"Sync Failed",description:"Unable to sync your changes. Will retry automatically.",variant:"destructive",duration:5e3}),!1}},[e?.id,a.isOnline,a.isSyncing,d,t]),g=s.useCallback(()=>{l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{m()},2e3)},[m]);s.useEffect(()=>{const e=()=>{console.log("ðŸŒ Network: Back online"),o(e=>({...e,isOnline:!0})),g()},s=()=>{console.log("ðŸ“± Network: Gone offline"),o(e=>({...e,isOnline:!1,isSyncing:!1})),l.current&&(clearTimeout(l.current),l.current=null)};return window.addEventListener("online",e),window.addEventListener("offline",s),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",s),l.current&&clearTimeout(l.current),c.current&&clearTimeout(c.current)}},[g]),s.useEffect(()=>(a.isOnline&&a.pendingCount>0&&!a.isSyncing&&(c.current=setTimeout(()=>{console.log("ðŸ”„ Retrying sync for pending operations"),m()},3e4)),()=>{c.current&&(clearTimeout(c.current),c.current=null)}),[a.isOnline,a.pendingCount,a.isSyncing,m]);const h=s.useCallback(()=>{o(e=>({...e,syncErrors:[]}))},[]),p=s.useCallback(()=>{a.isOnline&&!a.isSyncing&&m()},[a.isOnline,a.isSyncing,m]),f=s.useCallback(async()=>await r.getStorageStats(),[]),x=s.useCallback(async()=>{if(!e?.id)return!1;try{return await r.clearUserData(e.id),await d(),t({title:"Offline Data Cleared",description:"All offline data has been removed.",duration:3e3}),!0}catch(s){return console.error("âŒ Failed to clear offline data:",s),!1}},[e?.id,d,t]);return{...a,queueOperation:u,performSync:m,forceSync:p,clearSyncErrors:h,clearOfflineData:x,getStorageStats:f,isInitialized:!!e?.id,canSync:a.isOnline&&!a.isSyncing}},R=({className:n,variant:i="compact",showDetails:r=!1})=>{const{isOnline:l,isSyncing:c,pendingCount:d,lastSyncTime:g,syncErrors:h,forceSync:p,clearSyncErrors:f}=A(),[x,y]=s.useState(!1);s.useEffect(()=>{const e=!l||d>0||h.length>0;y(e&&"banner"===i)},[l,d,h.length,i]);const N=()=>l?c?e.jsx(C,{className:"h-4 w-4 animate-spin"}):h.length>0?e.jsx(w,{className:"h-4 w-4"}):d>0?e.jsx($,{className:"h-4 w-4"}):e.jsx(k,{className:"h-4 w-4"}):e.jsx(O,{className:"h-4 w-4"}),S=()=>l?c?"Syncing...":h.length>0?"Sync Issues":d>0?`${d} Pending`:"Online":"Offline",b=()=>{if(!g)return"Never synced";const e=(new Date).getTime()-g.getTime();return e<6e4?"Just now":e<36e5?`${Math.floor(e/6e4)}m ago`:e<864e5?`${Math.floor(e/36e5)}h ago`:g.toLocaleDateString()};return"compact"===i?e.jsxs(u,{variant:l?c?"default":h.length>0?"destructive":d>0?"secondary":"default":"destructive",className:o("flex items-center gap-1",n),"data-testid":"offline-indicator-compact",children:[N(),e.jsx("span",{className:"text-xs",children:S()})]}):"banner"===i&&x?e.jsx(t,{className:o("border-l-4 p-4 mb-4",l?h.length>0?"border-l-yellow-500 bg-yellow-50 dark:bg-yellow-950":"border-l-blue-500 bg-blue-50 dark:bg-blue-950":"border-l-red-500 bg-red-50 dark:bg-red-950",n),"data-testid":"offline-banner",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[N(),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:l?h.length>0?"Sync issues detected":"Changes pending sync":"You're offline"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:l?h.length>0?`${h.length} operations failed to sync. We'll keep trying.`:`${d} changes are waiting to sync to the server.`:"Some features may be limited. Changes will sync when you're back online."})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l&&(d>0||h.length>0)&&e.jsxs(a,{variant:"outline",size:"sm",onClick:p,disabled:c,"data-testid":"button-force-sync",children:[e.jsx(C,{className:"h-4 w-4 mr-1"}),"Retry Sync"]}),e.jsx(a,{variant:"ghost",size:"sm",onClick:()=>y(!1),"data-testid":"button-dismiss-banner",children:e.jsx(j,{className:"h-4 w-4"})})]})]})}):"full"===i?e.jsx(t,{className:o("p-4",n),"data-testid":"offline-indicator-full",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[N(),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:S()}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Last sync: ",b()]})]})]}),l&&e.jsxs(a,{variant:"outline",size:"sm",onClick:p,disabled:c,"data-testid":"button-manual-sync",children:[e.jsx(C,{className:"h-4 w-4 mr-1"}),"Sync Now"]})]}),c&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Syncing changes..."}),e.jsx(C,{className:"h-4 w-4 animate-spin"})]}),e.jsx(m,{value:75,className:"h-2"})]}),d>0&&!c&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-sm",children:[d," change",1!==d?"s":""," pending sync"]})]}),l&&e.jsx(a,{variant:"ghost",size:"sm",onClick:p,children:"Sync Now"})]}),h.length>0&&r&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium text-destructive",children:["Sync Errors (",h.length,")"]}),e.jsx(a,{variant:"ghost",size:"sm",onClick:f,"data-testid":"button-clear-errors",children:"Clear"})]}),e.jsxs("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:[h.slice(0,3).map((s,t)=>e.jsxs("div",{className:"flex items-start gap-2 p-2 bg-destructive/10 rounded text-sm",children:[e.jsx(w,{className:"h-4 w-4 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"truncate",children:s.error}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.timestamp.toLocaleTimeString()})]})]},s.id)),h.length>3&&e.jsxs("p",{className:"text-xs text-muted-foreground text-center py-1",children:["And ",h.length-3," more..."]})]})]}),l&&0===d&&0===h.length&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 dark:bg-green-950 rounded-lg",children:[e.jsx(v,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm text-green-600 dark:text-green-400",children:"All changes synced successfully"})]})]})}):null},I=()=>{const{user:e}=n(),{isOnline:t,queueOperation:a}=A(),{makeRequest:r}=(()=>{const{queueOperation:e,isOnline:t}=A();return i(),{makeRequest:s.useCallback(async(s,a,n)=>{try{const e=await fetch(a,{method:s,headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`},body:n?JSON.stringify(n):void 0});if(e.ok)return await e.json();throw new Error(`HTTP ${e.status}: ${e.statusText}`)}catch(p){if(!t&&("POST"===s||"PUT"===s||"DELETE"===s)){const t="POST"===s?"create":"PUT"===s?"update":"delete";if(await e(t,a,n))return{success:!0,offline:!0,message:"Operation queued for sync when online"}}throw p}},[e,t]),isOnline:t}})(),{toast:o}=i(),[u,m]=s.useState([]),[g,h]=s.useState(!0),[p,f]=s.useState(null),x=async()=>{if(e?.id){h(!0),f(null);try{if(t)try{const s=(await r("GET","/api/students")).students||[];await Promise.all(s.map(s=>l(s.id,s,e.id))),m(s)}catch(s){console.warn("Network request failed, falling back to offline data");const t=await c(e.id);m(t)}else{const s=await c(e.id);m(s),0===s.length&&f("No student data available offline. Please connect to load your students.")}}catch(a){console.error("Error loading students:",a),f("Failed to load student data");try{const s=await c(e.id);m(s)}catch(n){console.error("Failed to load offline students:",n)}}finally{h(!1)}}};return s.useEffect(()=>{x()},[e?.id,t]),{students:u,loading:g,error:p,createStudent:async s=>{if(!e?.id)throw new Error("User not authenticated");const n=`temp-${Date.now()}`,i={...s,id:n,lastUpdated:(new Date).toISOString()};try{if(t){const t=(await r("POST","/api/students",i)).student;return await l(t.id,t,e.id),m(e=>[...e,t]),o({title:"Student Added",description:`${s.name} has been added successfully.`,duration:3e3}),t}return await l(n,i,e.id),await a("create","/api/students",i),m(e=>[...e,i]),o({title:"Student Added (Offline)",description:`${s.name} will be synced when you're back online.`,duration:3e3}),i}catch(c){throw console.error("Error creating student:",c),c}},updateStudent:async(s,n)=>{if(!e?.id)throw new Error("User not authenticated");const i={...u.find(e=>e.id===s),...n,lastUpdated:(new Date).toISOString()};try{if(t){const t=(await r("PUT",`/api/students/${s}`,i)).student;return await l(t.id,t,e.id),m(e=>e.map(e=>e.id===s?t:e)),o({title:"Student Updated",description:"Changes saved successfully.",duration:3e3}),t}return await l(s,i,e.id),await a("update",`/api/students/${s}`,i),m(e=>e.map(e=>e.id===s?i:e)),o({title:"Student Updated (Offline)",description:"Changes will sync when you're back online.",duration:3e3}),i}catch(c){throw console.error("Error updating student:",c),c}},deleteStudent:async s=>{if(!e?.id)throw new Error("User not authenticated");try{t?(await r("DELETE",`/api/students/${s}`),m(e=>e.filter(e=>e.id!==s)),o({title:"Student Removed",description:"Student has been deleted successfully.",duration:3e3})):(await a("delete",`/api/students/${s}`,{id:s}),m(e=>e.filter(e=>e.id!==s)),o({title:"Student Removed (Offline)",description:"Deletion will sync when you're back online.",duration:3e3}))}catch(n){throw console.error("Error deleting student:",n),n}},getStudent:async s=>{try{const n=u.find(e=>e.id===s);if(n)return n;if(t)try{const t=(await r("GET",`/api/students/${s}`)).student;return e?.id&&await l(t.id,t,e.id),t}catch(a){console.warn("Network request failed, checking offline storage")}return await d(s)}catch(n){return console.error("Error getting student:",n),null}},refreshStudents:x,isOffline:!t}},q=()=>{const[n,i]=s.useState([]),{isOnline:o,pendingCount:l,queueOperation:c,forceSync:d}=A(),{students:m,isOffline:g}=I(),h=async()=>{i([]);const e=[];try{if("serviceWorker"in navigator){const s=await navigator.serviceWorker.ready;e.push({test:"Service Worker",status:s?"pass":"fail",message:s?"Service worker registered and active":"Service worker not found"})}else e.push({test:"Service Worker",status:"fail",message:"Service workers not supported"})}catch(s){e.push({test:"Service Worker",status:"fail",message:`Service worker error: ${s}`})}try{const s=await r.initialize();e.push({test:"IndexedDB Storage",status:s?"pass":"fail",message:s?"Offline storage initialized successfully":"Storage initialization failed"})}catch(s){e.push({test:"IndexedDB Storage",status:"fail",message:`Storage error: ${s}`})}e.push({test:"Network Detection",status:"pass",message:"Network status: "+(o?"Online":"Offline")});try{const s={test:"data",timestamp:Date.now()},t=await r.storeData("draft","test-item",s,"test-user"),a=await r.getData("draft","test-item");e.push({test:"Data Storage",status:t&&a?"pass":"fail",message:t&&a?"Data storage and retrieval working":"Data storage failed"})}catch(s){e.push({test:"Data Storage",status:"fail",message:`Data storage error: ${s}`})}try{const s=await c("create","/api/test",{test:"offline"});e.push({test:"Offline Queue",status:s?"pass":"fail",message:s?`Operation queued successfully (${l} pending)`:"Queue operation failed"})}catch(s){e.push({test:"Offline Queue",status:"fail",message:`Queue error: ${s}`})}try{const s=await caches.keys(),t=s.length>0;e.push({test:"Cache Storage",status:t?"pass":"fail",message:t?`${s.length} cache(s) active: ${s.join(", ")}`:"No caches found"})}catch(s){e.push({test:"Cache Storage",status:"fail",message:`Cache error: ${s}`})}i(e)};s.useEffect(()=>{h()},[]);const p=s=>{switch(s){case"pass":return e.jsx(v,{className:"h-4 w-4 text-green-600"});case"fail":return e.jsx(w,{className:"h-4 w-4 text-red-600"});default:return e.jsx(E,{className:"h-4 w-4 text-gray-400"})}};return e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Offline Functionality Test"}),e.jsx("p",{className:"text-muted-foreground",children:"Testing offline capabilities and service worker functionality"})]}),e.jsxs(t,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-medium",children:"Network Status"}),e.jsxs(u,{variant:o?"default":"destructive",children:[o?e.jsx(k,{className:"h-3 w-3 mr-1"}):e.jsx(O,{className:"h-3 w-3 mr-1"}),o?"Online":"Offline"]})]}),e.jsx(R,{variant:"full",showDetails:!0})]}),e.jsxs(t,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-medium",children:"Test Results"}),e.jsxs(a,{onClick:h,size:"sm","data-testid":"button-run-tests",children:[e.jsx(E,{className:"h-4 w-4 mr-1"}),"Run Tests"]})]}),e.jsx("div",{className:"space-y-2",children:n.map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[p(s.status),e.jsx("span",{className:"font-medium",children:s.test})]}),e.jsx("div",{className:"text-sm text-muted-foreground max-w-md text-right",children:s.message})]},t))})]}),e.jsxs(t,{className:"p-4",children:[e.jsx("h3",{className:"font-medium mb-4",children:"Offline Actions"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs(a,{onClick:async()=>{try{console.log("Testing offline students functionality"),console.log("Students available:",m.length),console.log("Students offline mode:",g)}catch(e){console.error("Offline students test failed:",e)}},variant:"outline",className:"w-full","data-testid":"button-test-students",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Test Student Data (",m.length," loaded)"]}),e.jsxs(a,{onClick:()=>c("create","/api/test-offline",{test:!0}),variant:"outline",className:"w-full","data-testid":"button-queue-operation",children:[e.jsx(C,{className:"h-4 w-4 mr-2"}),"Queue Test Operation"]}),e.jsxs(a,{onClick:d,variant:"outline",className:"w-full",disabled:!o,"data-testid":"button-force-sync",children:[e.jsx(C,{className:"h-4 w-4 mr-2"}),"Force Sync (",l," pending)"]}),e.jsxs(a,{onClick:()=>r.getStorageStats().then(e=>alert(`Storage: ${e?.itemCount||0} items, ${Math.round((e?.size||0)/1024)}KB`)),variant:"outline",className:"w-full","data-testid":"button-storage-stats",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Storage Stats"]})]})]}),e.jsxs(t,{className:"p-4 bg-blue-50 dark:bg-blue-950",children:[e.jsx("h3",{className:"font-medium mb-2",children:"Testing Instructions"}),e.jsxs("ol",{className:"text-sm space-y-1 list-decimal list-inside text-muted-foreground",children:[e.jsx("li",{children:'All tests should show "pass" status when online'}),e.jsx("li",{children:"Try turning off your network connection"}),e.jsx("li",{children:"Navigate to different pages - they should still load from cache"}),e.jsx("li",{children:"Try creating/editing data - it should queue for sync"}),e.jsx("li",{children:"Turn network back on - queued operations should sync automatically"}),e.jsx("li",{children:"Check the network status indicator updates correctly"})]})]})]})};function F(){return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(D,{}),e.jsx("div",{className:"mt-12 border-t pt-12",children:e.jsx(q,{})})]})}export{F as default};
