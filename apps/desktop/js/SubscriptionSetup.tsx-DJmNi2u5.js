import{j as e}from"./chunk-DsWtD-um.js";import{R as t,g as r,r as n}from"./chunk--CdJ9rTh.js";import{P as a}from"./chunk-Csgv8Z6q.js";import{a as o,C as s,h as i,B as c,d as l,e as u,f as d,L as p,I as m}from"../assets/index-2BchvXuI.js";import{v as f,a1 as h,E as y,x as g}from"./chunk-CIO6T0Sb.js";import"./chunk-DiCKXT8z.js";var x,w="basil",v="https://js.stripe.com",j="".concat(v,"/").concat(w,"/stripe.js"),b=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,N=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,C="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",S=function(e){return b.test(e)||N.test(e)},k=function(e){var t=document.createElement("script");t.src="".concat(j).concat("");var r=document.head||document.body;if(!r)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return r.appendChild(t),t},E=null,O=null,P=null,A=function(e){return null!==E?E:(E=new Promise(function(t,r){if("undefined"!=typeof window&&"undefined"!=typeof document)if(window.Stripe&&e&&console.warn(C),window.Stripe)t(window.Stripe);else try{var n=function(){for(var e=document.querySelectorAll('script[src^="'.concat(v,'"]')),t=0;t<e.length;t++){var r=e[t];if(S(r.src))return r}return null}();if(n&&e)console.warn(C);else if(n){if(n&&null!==P&&null!==O){var a;n.removeEventListener("load",P),n.removeEventListener("error",O),null===(a=n.parentNode)||void 0===a||a.removeChild(n),n=k()}}else n=k();P=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}}(t,r),O=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}}(r),n.addEventListener("load",P),n.addEventListener("error",O)}catch(o){return void r(o)}else t(null)})).catch(function(e){return E=null,Promise.reject(e)})},I=!1,R=function(){return x||(x=A(null).catch(function(e){return x=null,Promise.reject(e)}))};Promise.resolve().then(function(){return R()}).catch(function(e){I||console.warn(e)});function F(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function L(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?F(Object(r),!0).forEach(function(t){B(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):F(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function T(e){return(T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function B(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function q(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function U(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=e&&("undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]);if(null==r)return;var n,a,o=[],s=!0,i=!1;try{for(r=r.call(e);!(s=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);s=!0);}catch(c){i=!0,a=c}finally{try{s||null==r.return||r.return()}finally{if(i)throw a}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Y(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Y(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Y(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var D=function(e,r,n){var a=!!n,o=t.useRef(n);t.useEffect(function(){o.current=n},[n]),t.useEffect(function(){if(!a||!e)return function(){};var t=function(){o.current&&o.current.apply(o,arguments)};return e.on(r,t),function(){e.off(r,t)}},[a,r,e,o])},M=function(e){return null!==e&&"object"===T(e)},_="[object Object]",z=function e(t,r){if(!M(t)||!M(r))return t===r;var n=Array.isArray(t);if(n!==Array.isArray(r))return!1;var a=Object.prototype.toString.call(t)===_;if(a!==(Object.prototype.toString.call(r)===_))return!1;if(!a&&!n)return t===r;var o=Object.keys(t),s=Object.keys(r);if(o.length!==s.length)return!1;for(var i={},c=0;c<o.length;c+=1)i[o[c]]=!0;for(var l=0;l<s.length;l+=1)i[s[l]]=!0;var u=Object.keys(i);if(u.length!==o.length)return!1;var d=t,p=r;return u.every(function(t){return e(d[t],p[t])})},V=function(e,t,r){return M(e)?Object.keys(e).reduce(function(n,a){var o=!M(t)||!z(e[a],t[a]);return r.includes(a)?(o&&console.warn("Unsupported prop change: options.".concat(a," is not a mutable property.")),n):o?L(L({},n||{}),{},B({},a,e[a])):n},null):null},W=t.createContext(null);W.displayName="ElementsContext";a.any,a.object,a.func.isRequired;var X=t.createContext(null);X.displayName="CheckoutSdkContext";t.createContext(null).displayName="CheckoutContext",a.any,a.shape({fetchClientSecret:a.func.isRequired,elementsOptions:a.object}).isRequired;var Z=function(e){var r=t.useContext(X),n=t.useContext(W);if(r&&n)throw new Error("You cannot wrap the part of your app that ".concat(e," in both <CheckoutProvider> and <Elements> providers."));return r?function(e,t){if(!e)throw new Error("Could not find CheckoutProvider context; You need to wrap the part of your app that ".concat(t," in an <CheckoutProvider> provider."));return e}(r,e):function(e,t){if(!e)throw new Error("Could not find Elements context; You need to wrap the part of your app that ".concat(t," in an <Elements> provider."));return e}(n,e)},$=["mode"],H=function(e,r){var n,o="".concat((n=e).charAt(0).toUpperCase()+n.slice(1),"Element"),s=r?function(e){Z("mounts <".concat(o,">"));var r=e.id,n=e.className;return t.createElement("div",{id:r,className:n})}:function(r){var n,a=r.id,s=r.className,i=r.options,c=void 0===i?{}:i,l=r.onBlur,u=r.onFocus,d=r.onReady,p=r.onChange,m=r.onEscape,f=r.onClick,h=r.onLoadError,y=r.onLoaderStart,g=r.onNetworksChange,x=r.onConfirm,w=r.onCancel,v=r.onShippingAddressChange,j=r.onShippingRateChange,b=Z("mounts <".concat(o,">")),N="elements"in b?b.elements:null,C="checkoutSdk"in b?b.checkoutSdk:null,S=U(t.useState(null),2),k=S[0],E=S[1],O=t.useRef(null),P=t.useRef(null);D(k,"blur",l),D(k,"focus",u),D(k,"escape",m),D(k,"click",f),D(k,"loaderror",h),D(k,"loaderstart",y),D(k,"networkschange",g),D(k,"confirm",x),D(k,"cancel",w),D(k,"shippingaddresschange",v),D(k,"shippingratechange",j),D(k,"change",p),d&&(n="expressCheckout"===e?d:function(){d(k)}),D(k,"ready",n),t.useLayoutEffect(function(){if(null===O.current&&null!==P.current&&(N||C)){var t=null;if(C)switch(e){case"payment":t=C.createPaymentElement(c);break;case"address":if(!("mode"in c))throw new Error("You must supply options.mode. mode must be 'billing' or 'shipping'.");var r=c.mode,n=q(c,$);if("shipping"===r)t=C.createShippingAddressElement(n);else{if("billing"!==r)throw new Error("Invalid options.mode. mode must be 'billing' or 'shipping'.");t=C.createBillingAddressElement(n)}break;case"expressCheckout":t=C.createExpressCheckoutElement(c);break;case"currencySelector":t=C.createCurrencySelectorElement();break;case"taxId":t=C.createTaxIdElement(c);break;default:throw new Error("Invalid Element type ".concat(o,". You must use either the <PaymentElement />, <AddressElement options={{mode: 'shipping'}} />, <AddressElement options={{mode: 'billing'}} />, or <ExpressCheckoutElement />."))}else N&&(t=N.create(e,c));O.current=t,E(t),t&&t.mount(P.current)}},[N,C,c]);var A,I,R=(A=c,I=t.useRef(A),t.useEffect(function(){I.current=A},[A]),I.current);return t.useEffect(function(){if(O.current){var e=V(c,R,["paymentRequest"]);e&&"update"in O.current&&O.current.update(e)}},[c,R]),t.useLayoutEffect(function(){return function(){if(O.current&&"function"==typeof O.current.destroy)try{O.current.destroy(),O.current=null}catch(e){}}},[]),t.createElement("div",{id:a,className:s,ref:P})};return s.propTypes={id:a.string,className:a.string,onChange:a.func,onBlur:a.func,onFocus:a.func,onReady:a.func,onEscape:a.func,onClick:a.func,onLoadError:a.func,onLoaderStart:a.func,onNetworksChange:a.func,onConfirm:a.func,onCancel:a.func,onShippingAddressChange:a.func,onShippingRateChange:a.func,options:a.object},s.displayName=o,s.__elementType=e,s},J="undefined"==typeof window;function K(){console.log("🔥 SubscriptionSetup component loaded!");const[t]=r(),{toast:a}=o();n.useState("");const[x,w]=n.useState(!1),[v,j]=n.useState("account"),[b,N]=n.useState({firstName:"",lastName:"",email:"",password:"",confirmPassword:""}),[C,S]=n.useState(!1),[k,E]=n.useState(!1),[O,P]=n.useState(!1),A=t.get("priceId"),I=t.get("planName"),R=t.get("plan"),F=t.get("role");n.useEffect(()=>{console.log("🔍 Subscription Setup Validation:",{planName:I,planId:R,role:F,priceId:A,amount:t.get("amount"),allParams:Object.fromEntries(t.entries())}),R&&F||(console.error("Missing REQUIRED subscription parameters:",{planName:!!I,planId:!!R,role:!!F,actualValues:{planName:I,planId:R,role:F}}),a({title:"Invalid Subscription",description:"Missing subscription details. Please try again.",variant:"destructive"}),setTimeout(()=>{window.location.replace("/")},3e3))},[I,R,F,A,a,t]);const L=async e=>{if(e.preventDefault(),b.password===b.confirmPassword)if(b.password.length<6)a({title:"Password Too Short",description:"Password must be at least 6 characters",variant:"destructive"});else{P(!0);try{const e=await fetch("/api/create-account",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({firstName:b.firstName,lastName:b.lastName,email:b.email,password:b.password,role:F,subscriptionMetadata:{priceId:A,planName:I,planId:R,role:F,amount:t.get("amount")}})});if(!e.ok){const t=await e.json().catch(()=>({message:"Network error"}));throw new Error(t.message||"Failed to create account")}const r=await e.json();console.log("Account creation result:",r),a({title:"Account Created!",description:"Now setting up your payment..."}),j("payment"),await T()}catch(r){console.error("Account creation error:",r),a({title:"Account Creation Failed",description:r.message,variant:"destructive"})}finally{P(!1)}}else a({title:"Password Mismatch",description:"Passwords do not match",variant:"destructive"})},T=async()=>{w(!0);try{if("free"===R||"0"===t.get("amount"))return a({title:"Account Created!",description:"Check your email to complete setup..."}),void setTimeout(()=>{window.location.replace("/subscription-success?plan=free&role=parent")},2e3);const r="/api/create-checkout-session",n=t.get("amount"),o="hero"===R?495:void 0,s={priceId:A,planName:I,planId:R,role:F,amount:n,...o&&{setupFee:o},mode:A?"subscription":"payment"};console.log("🔍 CHECKOUT REQUEST BODY:",s);const i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok){const e=await i.json().catch(()=>({error:"Network error"}));throw new Error(e.error||"Failed to create checkout session")}const c=await i.json();if(console.log("Checkout session result:",c),!c.url)throw new Error("No checkout URL received");{let t=c.url;try{const e=new URL(c.url,window.location.origin);e.origin!==window.location.origin&&(t=e.pathname+e.search+e.hash)}catch(e){t=c.url}console.log("🔍 Stripe checkout redirect normalized:",c.url,"→",t),window.location.replace(t)}}catch(r){console.error("Checkout session error:",r),a({title:"Setup Failed",description:r.message,variant:"destructive"}),j("account")}finally{w(!1)}};return x?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/5 to-accent/5",children:e.jsx(s,{className:"w-full max-w-md",children:e.jsx(i,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(f,{className:"mx-auto h-8 w-8 animate-spin mb-4"}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"Setting up your subscription..."}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we prepare your payment."})]})})})}):"account"===v?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/5 to-accent/5 py-12",children:e.jsxs("div",{className:"container mx-auto px-4 max-w-md",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(c,{variant:"ghost",onClick:()=>window.location.replace("/"),className:"p-2 hover:bg-muted","data-testid":"button-back",children:[e.jsx(h,{className:"h-4 w-4 mr-2"}),"Back to Home"]})}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"Create Your Account"}),e.jsxs("p",{className:"text-lg text-gray-600",children:["First, let's create your ",F," account for the ",I," plan."]})]}),e.jsxs(s,{children:[e.jsxs(l,{children:[e.jsx(u,{className:"text-xl",children:"Account Information"}),e.jsxs(d,{children:["Plan: ",I," • Role: ",F?.charAt(0).toUpperCase()+F?.slice(1)]})]}),e.jsx(i,{children:e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"firstName",children:"First Name"}),e.jsx(m,{id:"firstName",type:"text",placeholder:"First name",value:b.firstName,onChange:e=>N({...b,firstName:e.target.value}),required:!0,"data-testid":"input-firstname"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"lastName",children:"Last Name"}),e.jsx(m,{id:"lastName",type:"text",placeholder:"Last name",value:b.lastName,onChange:e=>N({...b,lastName:e.target.value}),required:!0,"data-testid":"input-lastname"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"email",children:"Email Address"}),e.jsx(m,{id:"email",type:"email",placeholder:"your@email.com",value:b.email,onChange:e=>N({...b,email:e.target.value}),required:!0,"data-testid":"input-email"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"password",children:"Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(m,{id:"password",type:C?"text":"password",placeholder:"Create a password",value:b.password,onChange:e=>N({...b,password:e.target.value}),required:!0,"data-testid":"input-password"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>S(!C),children:C?e.jsx(y,{className:"h-4 w-4"}):e.jsx(g,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"confirmPassword",children:"Confirm Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(m,{id:"confirmPassword",type:k?"text":"password",placeholder:"Confirm your password",value:b.confirmPassword,onChange:e=>N({...b,confirmPassword:e.target.value}),required:!0,"data-testid":"input-confirm-password"}),e.jsx(c,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>E(!k),children:k?e.jsx(y,{className:"h-4 w-4"}):e.jsx(g,{className:"h-4 w-4"})})]})]}),e.jsx(c,{type:"submit",className:"w-full",size:"lg",disabled:O,"data-testid":"button-create-account",children:O?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),"Creating Account..."]}):"Create Account & Continue to Payment"})]})})]}),e.jsx("div",{className:"text-center mt-6",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Need help? ",e.jsx("a",{href:"mailto:support@myiephero.com",className:"underline",children:"Contact Support"})]})})]})}):x?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/5 to-accent/5",children:e.jsx(s,{className:"w-full max-w-md",children:e.jsx(i,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(f,{className:"mx-auto h-8 w-8 animate-spin mb-4"}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"Setting up your payment..."}),e.jsx("p",{className:"text-muted-foreground",children:"Redirecting to checkout..."})]})})})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/5 to-accent/5 py-12",children:e.jsx("div",{className:"container mx-auto px-4 max-w-2xl",children:e.jsx(s,{children:e.jsx(i,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"Redirecting to Payment..."}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"If you're not redirected automatically, please try again."}),e.jsx(c,{onClick:()=>window.location.replace("/pricing"),children:"Back to Pricing"})]})})})})})}t.createContext(null).displayName="EmbeddedCheckoutProviderContext",H("auBankAccount",J),H("card",J),H("cardNumber",J),H("cardExpiry",J),H("cardCvc",J),H("fpxBank",J),H("iban",J),H("idealBank",J),H("p24Bank",J),H("epsBank",J),H("payment",J),H("expressCheckout",J),H("currencySelector",J),H("paymentRequestButton",J),H("linkAuthentication",J),H("address",J),H("shippingAddress",J),H("paymentMethodMessaging",J),H("affirmMessage",J),H("afterpayClearpayMessage",J),H("taxId",J),function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];I=!0;var n=Date.now();R().then(function(e){return function(e,t,r){if(null===e)return null;var n=t[0].match(/^pk_test/),a=function(e){return 3===e?"v3":e}(e.version),o=w;n&&a!==o&&console.warn("Stripe.js@".concat(a," was loaded on the page, but @stripe/stripe-js@").concat("7.9.0"," expected Stripe.js@").concat(o,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var s=e.apply(void 0,t);return function(e,t){e&&e._registerWrapper&&e._registerWrapper({name:"stripe-js",version:"7.9.0",startTime:t})}(s,r),s}(e,t,n)})}("pk_test_51Rr3Ot8iKZXV0srZoLgITuaO6CwtlWVW4PVYgYVa3sfdcFbOy1t6OipSEXr9cYCFPrtOfL0kP8z8UTdvD0pa91tx00wNX0ZmGX");export{K as default};
