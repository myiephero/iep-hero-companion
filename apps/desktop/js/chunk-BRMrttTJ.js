import{j as e}from"./chunk-DsWtD-um.js";import{r as s}from"./chunk--CdJ9rTh.js";import{u as a}from"./chunk--P05M-BP.js";import{a as t,B as r,I as i,m as n}from"../assets/index-4xq_U8Za.js";import{P as l}from"./chunk-CeDn3LK_.js";import{B as o}from"./chunk-dWvI_tCU.js";import{A as d,a as c}from"./chunk-OMBrO3Ds.js";import{aD as m,X as u,v as p,N as h,aL as g,f,aM as x,x as w,aN as v,aC as j,au as y,av as b}from"./chunk-CIO6T0Sb.js";import{b as N,u as k}from"./chunk-DiCKXT8z.js";const S={"application/pdf":[".pdf"],"application/msword":[".doc"],"application/vnd.openxmlformats-officedocument.wordprocessingml.document":[".docx"],"text/plain":[".txt"],"image/jpeg":[".jpg",".jpeg"],"image/png":[".png"],"image/gif":[".gif"],"image/webp":[".webp"]},C=5242880,E=e=>{if(0===e)return"0 Bytes";const s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(2))+" "+["Bytes","KB","MB","GB"][s]};function U({onFilesChange:i,files:n,maxFiles:w=5,maxFileSize:v=10485760,disabled:j=!1}){const{toast:y}=t(),b=s.useCallback(async(e,s)=>{if(s.length>0){const e=s.map(({errors:e})=>e.map(e=>e.message).join(", ")).join("; ");y({title:"Some files were rejected",description:e,variant:"destructive"})}if(e.filter(e=>e.size>C).length>0&&y({title:"Large file detected",description:`Files over ${E(C)} may take longer to upload and process.`,variant:"default"}),n.length+e.length>w)return void y({title:"Too many files",description:`Maximum ${w} files allowed. Remove some files first.`,variant:"destructive"});const a=e.map(e=>({file:e,id:crypto.randomUUID(),progress:0,status:"uploading"})),t=[...n,...a];i(t);for(const n of a)try{await N(n,t,i)}catch(r){console.error("Error processing file:",r),k(n.id,"error",t,i)}},[n,w,y,i]),N=async(e,s,a)=>{try{let i;if(e.file.type.startsWith("image/"))try{i=await(t=e.file,new Promise((e,s)=>{const a=new FileReader;a.onload=s=>{const a=s.target?.result;e(a||"")},a.onerror=()=>s(new Error("Failed to read file")),a.readAsDataURL(t)}))}catch(r){console.warn("Failed to create image preview:",r)}const n=new FormData;n.append("files",e.file);const l=new XMLHttpRequest;l.upload.addEventListener("progress",s=>{if(s.lengthComputable){const t=Math.round(s.loaded/s.total*100);a(s=>s.map(s=>s.id===e.id?{...s,progress:Math.min(t,95)}:s))}}),l.addEventListener("load",()=>{if(200===l.status)try{const s=JSON.parse(l.responseText),t=s.files?.[0];if(!t)throw new Error("Invalid response format");a(s=>s.map(s=>s.id===e.id?{...s,progress:100,status:"completed",documentId:t.documentId,downloadUrl:t.downloadUrl,previewUrl:t.previewUrl||i}:s))}catch(r){console.error("Error parsing upload response:",r),k(e.id,"error",s,a,"Invalid response from server")}else{let r=`Upload failed (${l.status})`;try{r=JSON.parse(l.responseText).error||r}catch(t){}k(e.id,"error",s,a,r)}}),l.addEventListener("error",()=>{k(e.id,"error",s,a,"Network error during upload")}),l.addEventListener("abort",()=>{k(e.id,"error",s,a,"Upload cancelled")});const o=localStorage.getItem("authToken");l.open("POST",`/api/messaging/upload/${crypto.randomUUID()}`),o&&l.setRequestHeader("Authorization",`Bearer ${o}`),l.send(n)}catch(r){console.error("Error starting file upload:",r),k(e.id,"error",s,a,"Failed to start upload")}var t},k=(e,s,a,t,r)=>{t(a.map(a=>a.id===e?{...a,status:s,progress:a.progress,errorMessage:r}:a)),r&&y({title:"Upload failed",description:r,variant:"destructive"})},{getRootProps:U,getInputProps:F,isDragActive:D}=a({onDrop:b,accept:S,maxFiles:w,maxSize:v,disabled:j});return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{...U(),className:`\n          border-2 border-dashed rounded-lg p-4 text-center transition-colors cursor-pointer\n          ${D?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-muted-foreground/50"}\n          ${j?"opacity-50 cursor-not-allowed":""}\n        `,"data-testid":"file-drop-zone",children:[e.jsx("input",{...F(),"data-testid":"file-input"}),e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(m,{className:"h-6 w-6 text-muted-foreground"}),e.jsx("div",{className:"text-sm",children:D?e.jsx("p",{className:"text-primary font-medium",children:"Drop files here..."}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"font-medium",children:"Drag & drop files or click to browse"}),e.jsxs("p",{className:"text-muted-foreground",children:["PDF, DOC, images up to ",E(v)," each"]})]})})]})]}),n.length>0&&e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:n.map(s=>{const a=(t=s.file.type).startsWith("image/")?g:t.includes("pdf")?f:x;var t;return e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/30 rounded-lg border","data-testid":`file-item-${s.id}`,children:[e.jsxs("div",{className:"flex-shrink-0",children:[s.previewUrl||s.downloadUrl?e.jsx("img",{src:s.previewUrl||s.downloadUrl,alt:s.file.name,className:"h-8 w-8 rounded object-cover",onError:e=>{e.currentTarget.style.display="none",e.currentTarget.nextElementSibling?.classList.remove("hidden")}}):null,e.jsx(a,{className:"h-8 w-8 text-muted-foreground "+(s.previewUrl||s.downloadUrl?"hidden":"")})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.file.name}),e.jsx(r,{variant:"ghost",size:"sm",onClick:()=>(e=>{const s=n.filter(s=>s.id!==e);i(s)})(s.id),className:"h-6 w-6 p-0 hover:bg-destructive/10","data-testid":`remove-file-${s.id}`,children:e.jsx(u,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:E(s.file.size)}),"uploading"===s.status&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1",children:e.jsx(l,{value:s.progress,className:"h-1"})}),e.jsx(p,{className:"h-3 w-3 animate-spin"})]}),"completed"===s.status&&e.jsx(o,{variant:"secondary",className:"text-xs",children:"Ready"}),"error"===s.status&&e.jsxs(o,{variant:"destructive",className:"text-xs",children:[e.jsx(h,{className:"h-3 w-3 mr-1"}),s.errorMessage?"Error":"Failed"]})]})]})]},s.id)})}),n.length>0&&e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsxs("span",{children:[n.length," of ",w," files"]}),e.jsxs("span",{children:[n.filter(e=>"completed"===e.status).length," ready to send"]})]}),n.some(e=>"error"===e.status)&&e.jsxs(d,{variant:"destructive",children:[e.jsx(h,{className:"h-4 w-4"}),e.jsx(c,{children:"Some files failed to upload. Please try again or remove the failed files."})]})]})}const F=e=>e.startsWith("image/")?g:e.includes("pdf")?f:x,D=e=>{if(0===e)return"0 Bytes";const s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(2))+" "+["Bytes","KB","MB","GB"][s]},T=e=>({"application/pdf":"PDF","application/msword":"DOC","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"DOCX","text/plain":"TXT","image/jpeg":"JPG","image/jpg":"JPG","image/png":"PNG","image/gif":"GIF","image/webp":"WEBP"}[e]||e.split("/")[1]?.toUpperCase()||"FILE"),$=e=>e.startsWith("image/")&&["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e);function M({attachments:a,compact:i=!1}){const{toast:n}=t(),[l,d]=s.useState(new Set);if(!a||0===a.length)return null;const c=async e=>{if(e.downloadUrl)try{d(s=>new Set(s).add(e.id));const s=await fetch(e.downloadUrl,{credentials:"include",headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}});if(!s.ok)throw new Error(`Download failed: ${s.statusText}`);const a=await s.blob(),t=window.URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=e.file_name,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(t),n({title:"Download started",description:`${e.file_name} is downloading`})}catch(s){console.error("Download error:",s),n({title:"Download failed",description:s instanceof Error?s.message:"Failed to download file",variant:"destructive"})}finally{d(s=>{const a=new Set(s);return a.delete(e.id),a})}else n({title:"Download unavailable",description:"Download link not available for this file",variant:"destructive"})},m=e=>{const s=e.previewUrl||e.downloadUrl;s?window.location.replace(s):n({title:"Preview unavailable",description:"Preview not available for this file",variant:"destructive"})};if(i&&1===a.length){const s=a[0],t=F(s.file_type),i=s.previewUrl&&($(s.file_type)||"application/pdf"===s.file_type),n=l.has(s.id);return e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted/30 rounded border max-w-xs","data-testid":`attachment-compact-${s.id}`,children:[e.jsx(t,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-medium truncate",children:s.file_name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[T(s.file_type)," â€¢ ",D(s.file_size)]})]}),e.jsxs("div",{className:"flex gap-1",children:[i&&e.jsx(r,{variant:"ghost",size:"sm",onClick:()=>m(s),className:"h-6 w-6 p-0","data-testid":`preview-${s.id}`,children:e.jsx(w,{className:"h-3 w-3"})}),e.jsx(r,{variant:"ghost",size:"sm",onClick:()=>c(s),className:"h-6 w-6 p-0",disabled:n,"data-testid":`download-${s.id}`,children:n?e.jsx(p,{className:"h-3 w-3 animate-spin"}):e.jsx(v,{className:"h-3 w-3"})})]})]})}return e.jsxs("div",{className:"space-y-2 mt-2","data-testid":"attachments-list",children:[a.map(s=>{const a=F(s.file_type),t=s.previewUrl&&($(s.file_type)||"application/pdf"===s.file_type),i=l.has(s.id);return e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/20 rounded-lg border","data-testid":`attachment-${s.id}`,children:[e.jsx("div",{className:"flex-shrink-0",children:s.previewUrl&&$(s.file_type)?e.jsx("img",{src:s.previewUrl,alt:s.file_name,className:"h-10 w-10 rounded object-cover cursor-pointer",onClick:()=>m(s)}):e.jsx("div",{className:"h-10 w-10 rounded bg-muted flex items-center justify-center",children:e.jsx(a,{className:"h-5 w-5 text-muted-foreground"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.file_name}),e.jsx(o,{variant:"secondary",className:"text-xs",children:T(s.file_type)})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[D(s.file_size)," â€¢ ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex gap-1",children:[t&&e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>m(s),className:"h-8 px-3","data-testid":`preview-${s.id}`,children:[e.jsx(w,{className:"h-3 w-3 mr-1"}),"Preview"]}),e.jsx(r,{variant:"outline",size:"sm",onClick:()=>c(s),className:"h-8 px-3",disabled:i,"data-testid":`download-${s.id}`,children:i?e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"h-3 w-3 mr-1 animate-spin"}),"Downloading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"h-3 w-3 mr-1"}),"Download"]})})]})]},s.id)}),a.length>1&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.length," files attached"]})]})}function P({searchTerm:a,onSearchChange:t,currentResult:n,totalResults:l,onNext:d,onPrevious:c,onClear:m,placeholder:p="Search messages...",className:h=""}){const[g,f]=s.useState(a);s.useEffect(()=>{const e=setTimeout(()=>{t(g)},300);return()=>clearTimeout(e)},[g,t]),s.useEffect(()=>{f(a)},[a]);const x=s.useCallback(e=>{"Enter"===e.key?(e.preventDefault(),e.shiftKey?c():d()):"Escape"===e.key&&(e.preventDefault(),m())},[d,c,m]),w=l>0,v=a.trim().length>0;return e.jsxs("div",{className:`flex items-center gap-2 p-3 bg-muted/20 border-b ${h}`,children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(j,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(i,{value:g,onChange:e=>f(e.target.value),onKeyDown:x,placeholder:p,className:"pl-10 pr-8","data-testid":"input-search-messages"}),v&&e.jsx(r,{variant:"ghost",size:"sm",onClick:m,className:"absolute right-1 top-1/2 transform -translate-y-1/2 h-6 w-6 p-0 hover:bg-muted","data-testid":"button-clear-search",children:e.jsx(u,{className:"h-3 w-3"})})]}),v&&e.jsx("div",{className:"flex items-center gap-2",children:w?e.jsxs(e.Fragment,{children:[e.jsxs(o,{variant:"secondary",className:"text-xs font-mono",children:[n+1," of ",l]}),e.jsxs("div",{className:"flex",children:[e.jsx(r,{variant:"ghost",size:"sm",onClick:c,disabled:0===l,className:"h-8 w-8 p-0",title:"Previous result (Shift+Enter)","data-testid":"button-previous-result",children:e.jsx(y,{className:"h-4 w-4"})}),e.jsx(r,{variant:"ghost",size:"sm",onClick:d,disabled:0===l,className:"h-8 w-8 p-0",title:"Next result (Enter)","data-testid":"button-next-result",children:e.jsx(b,{className:"h-4 w-4"})})]})]}):e.jsx(o,{variant:"secondary",className:"text-xs",children:"No results"})})]})}function R({text:a,searchTerm:t,isCurrentResult:r=!1,className:i=""}){const n=s.useMemo(()=>{if(!t.trim()||!a)return a;const s=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return a.split(new RegExp(`(${s})`,"gi")).map((s,a)=>a%2==1?e.jsx("mark",{className:"px-1 py-0.5 rounded-sm font-medium "+(r?"bg-yellow-300 text-yellow-900 ring-2 ring-yellow-400":"bg-yellow-200 text-yellow-800"),"data-testid":r?"highlight-current":"highlight-match",children:s},a):s)},[a,t,r]);return e.jsx("span",{className:i,children:n})}function L(e){const[a,t]=s.useState(""),[r,i]=s.useState(0),n=s.useMemo(()=>{if(!a.trim()||!e.length)return[];const s=a.trim().toLowerCase();return e.map((e,s)=>({message:e,index:s})).filter(({message:e})=>e.content&&e.content.toLowerCase().includes(s))},[e,a]),l=s.useMemo(()=>a.trim()?n.map(e=>e.message):e,[e,n,a]),o=s.useMemo(()=>0===n.length?null:n[r]||null,[n,r]);s.useEffect(()=>{i(0)},[a]);const d=s.useCallback(()=>{0!==n.length&&i(e=>(e+1)%n.length)},[n.length]),c=s.useCallback(()=>{0!==n.length&&i(e=>0===e?n.length-1:e-1)},[n.length]),m=s.useCallback(()=>{t(""),i(0)},[]),u=s.useCallback(e=>!!o&&o.message.id===e,[o]),p=s.useCallback(e=>!!a.trim()&&n.some(s=>s.message.id===e),[n,a]);return{searchTerm:a,currentResultIndex:r,searchResults:n,filteredMessages:l,currentSearchResult:o,totalResults:n.length,setSearchTerm:t,goToNext:d,goToPrevious:c,clearSearch:m,isCurrentResult:u,hasSearchMatch:p,hasActiveSearch:a.trim().length>0,hasResults:n.length>0}}function z(){const{data:e,isLoading:s,error:a,refetch:t}=k({queryKey:["/api/messaging/labels"],staleTime:3e5});return{labels:e?.labels||[],loading:s,error:a?.message||null,refetch:t}}function _(){const[e,a]=s.useState(!1),t=N();return{create:s.useCallback(async e=>{a(!0);try{const s=await n("POST","/api/messaging/labels",JSON.stringify(e));if(!s.ok){const e=await s.json();throw new Error(e.error||"Failed to create label")}const a=await s.json();return t.invalidateQueries({queryKey:["/api/messaging/labels"]}),a.label}finally{a(!1)}},[t]),creating:e}}function B(){const[e,a]=s.useState(!1),t=N();return{update:s.useCallback(async(e,s)=>{a(!0);try{const a=await n("PUT",`/api/messaging/labels/${e}`,JSON.stringify(s));if(!a.ok){const e=await a.json();throw new Error(e.error||"Failed to update label")}const r=await a.json();return t.invalidateQueries({queryKey:["/api/messaging/labels"]}),r.label}finally{a(!1)}},[t]),updating:e}}function O(){const[e,a]=s.useState(!1),t=N();return{delete:s.useCallback(async e=>{a(!0);try{const s=await n("DELETE",`/api/messaging/labels/${e}`);if(!s.ok){const e=await s.json();throw new Error(e.error||"Failed to delete label")}t.invalidateQueries({queryKey:["/api/messaging/labels"]})}finally{a(!1)}},[t]),deleting:e}}function I(e){const{data:s,isLoading:a,error:t,refetch:r}=k({queryKey:["/api/messaging/conversations",e,"labels"],queryFn:async()=>{const s=await n("GET",`/api/messaging/conversations/${e}/labels`);if(!s.ok)throw new Error("Failed to fetch conversation labels");return s.json()},enabled:!!e,staleTime:12e4});return{labels:s?.labels||[],loading:a,error:t?.message||null,refetch:r}}function K(){const[e,a]=s.useState(!1),t=N();return{assign:s.useCallback(async(e,s)=>{a(!0);try{const a=await n("POST",`/api/messaging/conversations/${e}/labels`,JSON.stringify({label_ids:s}));if(!a.ok){const e=await a.json();throw new Error(e.error||"Failed to assign labels")}t.invalidateQueries({queryKey:["/api/messaging/conversations",e,"labels"]}),t.invalidateQueries({queryKey:["/api/messaging/conversations"]})}finally{a(!1)}},[t]),assigning:e}}function q(){const[e,a]=s.useState(!1),t=N();return{updateStatus:s.useCallback(async(e,s)=>{a(!0);try{const a=await n("PUT",`/api/messaging/conversations/${e}`,JSON.stringify(s));if(!a.ok){const e=await a.json();throw new Error(e.error||"Failed to update conversation status")}const r=await a.json();return t.invalidateQueries({queryKey:["/api/messaging/conversations"]}),r.conversation}finally{a(!1)}},[t]),updating:e}}export{P as M,_ as a,B as b,O as c,I as d,K as e,q as f,L as g,R as h,M as i,U as j,z as u};
