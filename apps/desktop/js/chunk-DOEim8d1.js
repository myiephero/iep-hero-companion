import{r as e}from"./chunk--CdJ9rTh.js";import{u as n,b as s,c as t}from"./chunk-DiCKXT8z.js";import{m as a}from"../assets/index-DmH44GAo.js";async function o(e){if(!e.ok)throw new Error(`API request failed: ${e.statusText}`);return e.json()}async function r(e){const n=await a("POST","/api/messaging/messages",e);return(await o(n)).message}async function i(e){const n=await a("POST",`/api/messaging/conversations/${e}/mark-read`);await o(n)}function c(s={},t=!0){const r=e.useMemo(()=>s,[JSON.stringify(s)]);console.log("🔍 useConversations DEBUG - Hook called with:",{filters:r,enabled:t,hasAuthToken:!!localStorage.getItem("authToken"),authToken:localStorage.getItem("authToken")?"[PRESENT]":"[MISSING]"});const{data:i,isLoading:c,error:u,refetch:g}=n({queryKey:["/api/messaging/conversations",r],queryFn:async()=>{console.log("🔍 useConversations DEBUG - Query function called, about to call getConversations with:",r);try{const e=await async function(e={}){console.log("🔍 getConversations DEBUG - Called with filters:",e);const n=new URLSearchParams;void 0!==e.archived&&n.append("archived",String(e.archived)),e.priority&&n.append("priority",e.priority),e.status&&n.append("status",e.status),e.label_ids&&e.label_ids.length>0&&n.append("label_ids",e.label_ids.join(",")),e.search&&n.append("search",e.search),e.page&&n.append("page",String(e.page)),e.limit&&n.append("limit",String(e.limit));const s="/api/messaging/conversations"+(n.toString()?`?${n.toString()}`:"");console.log("🔍 getConversations DEBUG - Making request to:",s);const t=await a("GET",s);console.log("🔍 getConversations DEBUG - Response status:",t.status);const r=await o(t);return console.log("🔍 getConversations DEBUG - Response data:",r),{conversations:r.conversations,pagination:r.pagination}}(r);return console.log("🔍 useConversations DEBUG - getConversations returned:",e),e}catch(e){throw console.error("🔍 useConversations DEBUG - getConversations error:",e),e}},enabled:t,staleTime:3e4,refetchOnWindowFocus:!1,retry:1});console.log("🔍 useConversations DEBUG - Query result:",{data:i,loading:c,queryError:u,conversations:i?.conversations,conversationsLength:i?.conversations?.length});const l=u?u instanceof Error?u.message:"Failed to fetch conversations":null;return{conversations:i?.conversations||[],pagination:i?.pagination||null,loading:c,error:l,refetch:()=>g()}}function u(e,s=!0){const{data:t,isLoading:r,error:i,refetch:c}=n({queryKey:["/api/messaging/conversations",e],queryFn:()=>async function(e){return o(await a("GET",`/api/messaging/conversations/${e}`))}(e),enabled:s&&!!e,staleTime:15e3,refetchOnWindowFocus:!1,retry:1});return{messageHistory:t||null,loading:r,error:i?i instanceof Error?i.message:"Failed to fetch messages":null,refetch:()=>c()}}function g(){const e=s(),n=t({mutationFn:async e=>{const n={conversation_id:e.conversationId};return e.content&&(n.content=e.content),e.documentIds&&e.documentIds.length>0&&(n.documentIds=e.documentIds),r(n)},onSuccess:(n,s)=>{e.invalidateQueries({queryKey:["/api/messaging/conversations"]}),e.invalidateQueries({queryKey:["/api/messaging/conversations",s.conversationId]})}});return{send:async(e,s,t)=>{try{return await n.mutateAsync({conversationId:e,content:s,documentIds:t})}catch(a){return console.error("Error sending message:",a),null}},sending:n.isPending,error:n.error?n.error instanceof Error?n.error.message:"Failed to send message":null}}function l(){const e=s(),n=t({mutationFn:e=>async function(e){const n=await a("POST","/api/messaging/conversations",e);return(await o(n)).conversation}({advocate_id:e.advocateId,student_id:e.studentId,parent_id:e.parentId}),onSuccess:()=>{e.invalidateQueries({queryKey:["/api/messaging/conversations"]})}});return{create:async(e,s,t)=>{try{return await n.mutateAsync({advocateId:e,studentId:t,parentId:s})}catch(a){return console.error("Error creating conversation:",a),null}},creating:n.isPending,error:n.error?n.error instanceof Error?n.error.message:"Failed to create conversation":null}}function d(){const e=s(),n=t({mutationFn:i,onSuccess:(n,s)=>{e.invalidateQueries({queryKey:["/api/messaging/conversations"]}),e.invalidateQueries({queryKey:["/api/messaging/conversations",s]}),e.invalidateQueries({queryKey:["/api/messaging/unread-count"]})}});return{markMessagesRead:async e=>{try{await n.mutateAsync(e)}catch(s){console.error("Error marking messages as read:",s)}}}}function m(e=!0){const{data:s,isLoading:t,error:o,refetch:r}=n({queryKey:["/api/messaging/proposal-contacts"],queryFn:async()=>{const e=await a("GET","/api/messaging/proposal-contacts");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return(await e.json()).contacts||[]},enabled:e,staleTime:3e4,refetchOnWindowFocus:!1,retry:1});return{contacts:s||[],loading:t,error:o?o instanceof Error?o.message:"Failed to fetch proposal contacts":null,refetch:()=>r()}}export{g as a,c as b,m as c,u as d,d as e,r as s,l as u};
