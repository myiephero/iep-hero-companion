#!/bin/bash

# My IEP Hero - Play Console Upload Helper Script
# Provides guidance and automation for uploading AAB to Play Console

set -e

echo "üöÄ My IEP Hero - Play Console Upload Guide"
echo "========================================"

# Configuration
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
OUTPUT_DIR="$PROJECT_ROOT/dist/android"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# Find latest AAB file
LATEST_AAB=$(find "$OUTPUT_DIR" -name "MyIEPHero-*.aab" -type f -exec ls -t {} + | head -1)

if [ -z "$LATEST_AAB" ]; then
    log_warning "No AAB files found in $OUTPUT_DIR"
    echo "Please build AAB first:"
    echo "  scripts/android/build-aab.sh"
    exit 1
fi

log_info "Latest AAB found: $(basename "$LATEST_AAB")"

echo ""
echo "üìã Play Console Upload Checklist"
echo "================================"
echo ""

# Pre-upload checklist
echo "üîç Pre-Upload Verification:"
echo "   ‚ñ° AAB file generated: ‚úÖ $(basename "$LATEST_AAB")"
echo "   ‚ñ° File size: $(ls -lh "$LATEST_AAB" | awk '{print $5}')"

# Check if keystore was used
if grep -q "debug" "$LATEST_AAB" 2>/dev/null; then
    log_warning "   ‚ñ° Signing: DEBUG KEYSTORE DETECTED!"
    echo "     ‚ö†Ô∏è  This AAB appears to be signed with debug keystore"
    echo "     ‚ö†Ô∏è  For production, regenerate with production keystore"
else
    log_success "   ‚ñ° Signing: Production keystore (assumed)"
fi

echo ""
echo "üè™ Play Console Setup Steps:"
echo "============================"
echo ""
echo "1. üìù Create Play Console Account (if needed):"
echo "   ‚Ä¢ Go to: https://play.google.com/console"
echo "   ‚Ä¢ Sign in with Google account"
echo "   ‚Ä¢ Pay \$25 one-time developer registration fee"
echo ""

echo "2. üÜï Create New App:"
echo "   ‚Ä¢ Click 'Create app'"
echo "   ‚Ä¢ App name: My IEP Hero"
echo "   ‚Ä¢ Default language: English"
echo "   ‚Ä¢ App or game: App"
echo "   ‚Ä¢ Free or paid: Free"
echo "   ‚Ä¢ Privacy Policy: Required for educational apps"
echo ""

echo "3. üì± App Setup:"
echo "   ‚Ä¢ Main store listing:"
echo "     - App name: My IEP Hero"
echo "     - Short description: IEP advocacy and special education support"
echo "     - Full description: Educational advocacy platform for IEP management"
echo "     - Category: Education"
echo "     - Content rating: Everyone (ESRB E)"
echo ""

echo "4. üîß App Content:"
echo "   ‚Ä¢ Content rating questionnaire:"
echo "     - Educational content: Yes"
echo "     - Target age: All ages"
echo "     - Data collection: Declare if applicable"
echo ""

echo "5. üì§ Upload AAB:"
echo "   ‚Ä¢ Go to 'Release' > 'Testing' > 'Internal testing'"
echo "   ‚Ä¢ Create new release"
echo "   ‚Ä¢ Upload AAB: $LATEST_AAB"
echo "   ‚Ä¢ Add release notes"
echo "   ‚Ä¢ Set version name and rollout percentage"
echo ""

echo "6. üë• Configure Internal Testing:"
echo "   ‚Ä¢ Add internal testers (email addresses)"
echo "   ‚Ä¢ Create testing groups if needed"
echo "   ‚Ä¢ Generate shareable link for testers"
echo ""

echo "7. üöÄ Publish to Internal Track:"
echo "   ‚Ä¢ Review all sections"
echo "   ‚Ä¢ Submit for review"
echo "   ‚Ä¢ Wait for processing (usually 1-3 hours)"
echo ""

echo "üìû Commands for this AAB:"
echo "========================"
echo ""
echo "# Open Play Console:"
echo "open https://play.google.com/console"
echo ""
echo "# Verify AAB locally (if bundletool installed):"
echo "bundletool validate --bundle=\"$LATEST_AAB\""
echo ""
echo "# Generate universal APK for testing (if bundletool installed):"
echo "bundletool build-apks --bundle=\"$LATEST_AAB\" --output=\"${LATEST_AAB%.aab}.apks\" --mode=universal"
echo ""

echo "üéØ Internal Testing URLs:"
echo "========================="
echo "After publishing to internal track, testers can access:"
echo "‚Ä¢ Testing link: [Generated by Play Console]"
echo "‚Ä¢ Play Store link: https://play.google.com/store/apps/details?id=com.myiephero.app"
echo ""

echo "‚è∞ Timeline Expectations:"
echo "========================"
echo "‚Ä¢ AAB upload and processing: 1-3 hours"
echo "‚Ä¢ Internal testing availability: Immediate after processing"
echo "‚Ä¢ Closed testing track: Up to 24 hours"
echo "‚Ä¢ Production review: 7 days (typical)"
echo ""

echo "üîó Useful Links:"
echo "================="
echo "‚Ä¢ Play Console: https://play.google.com/console"
echo "‚Ä¢ Developer Policy: https://play.google.com/about/developer-content-policy/"
echo "‚Ä¢ AAB Documentation: https://developer.android.com/guide/app-bundle"
echo "‚Ä¢ Bundletool: https://github.com/google/bundletool/releases"
echo ""

log_success "Upload guide complete! üéâ"
echo "Follow the steps above to upload your AAB to Play Console internal testing."