
import { useState, useEffect } from "react";
import { useQuery } from "@tanstack/react-query";
import { queryClient } from "@/lib/queryClient";
import { DashboardLayout } from "@/layouts/DashboardLayout";
import { DocumentUpload } from "@/components/DocumentUpload";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from "@/components/ui/dialog";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from "@/components/ui/dropdown-menu";
import { Label } from "@/components/ui/label";
import { api } from "@/lib/api";
import { 
  FileText, 
  Search, 
  Filter,
  Download,
  Eye,
  Calendar,
  Clock,
  Shield,
  Folder,
  Upload,
  Trash2,
  Edit,
  User,
  Check,
  X,
  MoreVertical,
  Share
} from "lucide-react";
import { format } from "date-fns";
import { useToast } from "@/hooks/use-toast";

const DocumentVault = () => {
  const [searchTerm, setSearchTerm] = useState("");
  const [filterType, setFilterType] = useState("all");
  const [editingDocument, setEditingDocument] = useState<{id: string, currentName: string} | null>(null);
  const [newFileName, setNewFileName] = useState('');
  const [assigningDocument, setAssigningDocument] = useState<string | null>(null);
  const [selectedStudentId, setSelectedStudentId] = useState<string>('');
  const { toast } = useToast();

  // Force refresh function
  const forceRefresh = () => {
    queryClient.invalidateQueries({ queryKey: ['documents'] });
    refetch();
  };

  // Get students for search functionality
  const { data: students } = useQuery({
    queryKey: ['students'],
    queryFn: () => api.getStudents()
  });

  const { data: documents, isLoading, refetch } = useQuery({
    queryKey: ['documents'],
    queryFn: () => api.getDocuments(),
    staleTime: 0, // Always refetch to ensure we get the latest data
    gcTime: 0 // Don't cache the data
  });

  const handleDeleteDocument = async (documentId: string, fileName: string) => {
    try {
      await api.deleteDocument(documentId);

      toast({
        title: "Document Deleted",
        description: `Successfully deleted ${fileName}`,
      });

      refetch(); // Refresh the document list
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to delete document. Please try again.",
        variant: "destructive",
      });
    }
  };

  const handleEditFileName = (id: string, currentName: string) => {
    setEditingDocument({ id, currentName });
    setNewFileName(currentName);
  };

  const handleUpdateFileName = async () => {
    if (!editingDocument || !newFileName.trim()) return;
    
    try {
      await api.updateDocument(editingDocument.id, { title: newFileName.trim() });
      queryClient.invalidateQueries({ queryKey: ['documents'] });
      toast({
        title: "Document Updated",
        description: `Successfully renamed to "${newFileName.trim()}"`,
      });
      setEditingDocument(null);
      setNewFileName('');
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to update document name. Please try again.",
        variant: "destructive",
      });
    }
  };

  const handleCancelEdit = () => {
    setEditingDocument(null);
    setNewFileName('');
  };

  const handleAssignToStudent = (documentId: string) => {
    setAssigningDocument(documentId);
    setSelectedStudentId('');
  };

  const handleUpdateStudentAssignment = async () => {
    if (!assigningDocument || !selectedStudentId) return;
    
    try {
      await api.updateDocument(assigningDocument, { student_id: selectedStudentId });
      queryClient.invalidateQueries({ queryKey: ['documents'] });
      const student = students?.find(s => s.id === selectedStudentId);
      toast({
        title: "Student Assigned",
        description: `Successfully assigned to ${student?.full_name || 'student'}`,
      });
      setAssigningDocument(null);
      setSelectedStudentId('');
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to assign student. Please try again.",
        variant: "destructive",
      });
    }
  };

  const handleViewDocument = (document: any) => {
    if (document.category === 'AI Analysis' && document.content) {
      // Parse the structured analysis content
      let analysisData;
      try {
        analysisData = JSON.parse(document.content);
      } catch (error) {
        analysisData = { rawAnalysis: document.content };
      }

      // Create a beautiful HTML view for AI Analysis
      const newWindow = window.open('', '_blank');
      if (newWindow) {
        newWindow.document.write(`
          <html>
            <head>
              <title>${document.title}</title>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <style>
                body {
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                  margin: 0;
                  padding: 32px;
                  line-height: 1.6;
                  background-color: #f8fafc;
                  color: #1e293b;
                }
                .container { max-width: 4xl; margin: 0 auto; }
                .header {
                  background: white;
                  border-radius: 12px;
                  padding: 24px;
                  margin-bottom: 24px;
                  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                  border-left: 4px solid #3b82f6;
                }
                .title { font-size: 28px; font-weight: bold; margin: 0 0 8px 0; }
                .subtitle { color: #64748b; margin: 0; }
                .section {
                  background: white;
                  border-radius: 12px;
                  padding: 20px;
                  margin-bottom: 16px;
                  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                  overflow: hidden;
                }
                .section-header {
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  margin-bottom: 16px;
                  font-weight: 600;
                  font-size: 18px;
                }
                .section-content { font-size: 14px; line-height: 1.6; }
                .section-content ul { margin: 0; padding-left: 20px; }
                .section-content li { margin-bottom: 8px; }
                .blue { border-left: 4px solid #3b82f6; background: #eff6ff; }
                .blue .section-header { color: #1d4ed8; }
                .green { border-left: 4px solid #10b981; background: #ecfdf5; }
                .green .section-header { color: #047857; }
                .orange { border-left: 4px solid #f59e0b; background: #fffbeb; }
                .orange .section-header { color: #d97706; }
                .emerald { border-left: 4px solid #10b981; background: #ecfdf5; }
                .emerald .section-header { color: #059669; }
                .purple { border-left: 4px solid #8b5cf6; background: #f3e8ff; }
                .purple .section-header { color: #7c3aed; }
                .icon { width: 20px; height: 20px; display: inline-block; }
                .meta {
                  display: flex;
                  gap: 16px;
                  font-size: 14px;
                  color: #64748b;
                  margin-top: 8px;
                }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1 class="title">üß† ${document.title}</h1>
                  <p class="subtitle">${document.description || 'AI-powered IEP analysis'}</p>
                  <div class="meta">
                    <span>üìÖ ${new Date(document.created_at).toLocaleDateString()}</span>
                    <span>üîç ${analysisData.reviewType || 'Analysis'}</span>
                    ${analysisData.studentId ? '<span>üë§ Student-specific</span>' : ''}
                  </div>
                </div>
                
                ${analysisData.analysis ? `
                  ${analysisData.analysis.summary ? `
                    <div class="section blue">
                      <div class="section-header">
                        üìÑ Summary
                      </div>
                      <div class="section-content">
                        ${Array.isArray(analysisData.analysis.summary) 
                          ? '<ul>' + analysisData.analysis.summary.map(item => '<li>' + item + '</li>').join('') + '</ul>'
                          : '<p>' + analysisData.analysis.summary + '</p>'
                        }
                      </div>
                    </div>
                  ` : ''}
                  
                  ${analysisData.analysis.recommendations && analysisData.analysis.recommendations.length > 0 ? `
                    <div class="section green">
                      <div class="section-header">
                        üìà Recommendations
                      </div>
                      <div class="section-content">
                        <ul>
                          ${analysisData.analysis.recommendations.map(item => '<li>' + item + '</li>').join('')}
                        </ul>
                      </div>
                    </div>
                  ` : ''}
                  
                  ${analysisData.analysis.areas_of_concern && analysisData.analysis.areas_of_concern.length > 0 ? `
                    <div class="section orange">
                      <div class="section-header">
                        ‚ö†Ô∏è Areas of Concern
                      </div>
                      <div class="section-content">
                        <ul>
                          ${analysisData.analysis.areas_of_concern.map(item => '<li>' + item + '</li>').join('')}
                        </ul>
                      </div>
                    </div>
                  ` : ''}
                  
                  ${analysisData.analysis.strengths && analysisData.analysis.strengths.length > 0 ? `
                    <div class="section emerald">
                      <div class="section-header">
                        ‚úÖ Strengths
                      </div>
                      <div class="section-content">
                        <ul>
                          ${analysisData.analysis.strengths.map(item => '<li>' + item + '</li>').join('')}
                        </ul>
                      </div>
                    </div>
                  ` : ''}
                  
                  ${analysisData.analysis.action_items && analysisData.analysis.action_items.length > 0 ? `
                    <div class="section purple">
                      <div class="section-header">
                        üéØ Action Items
                      </div>
                      <div class="section-content">
                        <ul>
                          ${analysisData.analysis.action_items.map(item => '<li>' + item + '</li>').join('')}
                        </ul>
                      </div>
                    </div>
                  ` : ''}
                ` : `
                  <div class="section">
                    <div class="section-header">üìã Analysis Results</div>
                    <div class="section-content">
                      <pre style="white-space: pre-wrap; font-family: inherit;">${analysisData.rawAnalysis || 'No analysis content available'}</pre>
                    </div>
                  </div>
                `}
              </div>
            </body>
          </html>
        `);
        newWindow.document.close();
      }
    } else if (document.content) {
      // For other content types, show basic viewer
      const newWindow = window.open('', '_blank');
      if (newWindow) {
        newWindow.document.write(`
          <html>
            <head><title>${document.title}</title></head>
            <body style="font-family: Arial, sans-serif; margin: 20px; line-height: 1.6;">
              <h1>${document.title}</h1>
              <div style="white-space: pre-wrap;">${document.content}</div>
            </body>
          </html>
        `);
        newWindow.document.close();
      }
    } else {
      // For original files, we would need the file URL from the server
      toast({
        title: "View Document",
        description: "Document viewer will be implemented soon",
      });
    }
  };

  const handleDownloadDocument = (document: any) => {
    if (document.content) {
      // Download analysis as JSON file
      const blob = new Blob([document.content], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${document.file_name}`;
      a.click();
      URL.revokeObjectURL(url);
    } else {
      // For original files, we would need to fetch from server
      toast({
        title: "Download Document",
        description: "Document download will be implemented soon",
      });
    }
  };

  const handleShareDocument = (document: any) => {
    // Copy document link to clipboard (simplified implementation)
    const shareUrl = `${window.location.origin}/documents/${document.id}`;
    navigator.clipboard.writeText(shareUrl).then(() => {
      toast({
        title: "Link Copied",
        description: "Document link copied to clipboard",
      });
    }).catch(() => {
      toast({
        title: "Share Document",
        description: "Sharing functionality will be implemented soon",
      });
    });
  };

  const filteredDocuments = documents?.filter(doc => {
    // Find student name for this document
    const student = students?.find(s => s.id === doc.student_id);
    const studentName = student ? student.full_name : '';
    
    const matchesSearch = doc.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         doc.file_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         studentName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         doc.category?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         doc.tags?.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()));
    
    const matchesType = filterType === 'all' || 
                       doc.file_type?.includes(filterType) ||
                       doc.category?.toLowerCase().includes(filterType.toLowerCase());
    
    return matchesSearch && matchesType;
  });

  const getFileTypeIcon = (fileType: string) => {
    if (fileType?.includes('pdf')) return 'üìÑ';
    if (fileType?.includes('doc')) return 'üìù';
    if (fileType?.includes('txt')) return 'üìã';
    return 'üìÅ';
  };

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  return (
    <DashboardLayout>
      <div className="space-y-8">
        {/* Header */}
        <div className="space-y-2">
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Shield className="h-8 w-8 text-blue-600" />
            Document Vault
          </h1>
          <p className="text-muted-foreground">
            Secure storage and management for all your IEP documents
          </p>
        </div>

        {/* Upload Section */}
        <DocumentUpload onAnalysisComplete={(analysis) => {
          console.log('Analysis completed:', analysis);
        }} />

        {/* Search and Filter */}
        <Card className="bg-gradient-card border-0">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Folder className="h-5 w-5" />
              Document Library
            </CardTitle>
            <CardDescription>
              Search and organize your uploaded documents
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex flex-col md:flex-row gap-4 mb-6">
              <div className="flex-1 relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="Search by document name, student name, category, or tags..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10"
                />
              </div>
              <Select value={filterType} onValueChange={setFilterType}>
                <SelectTrigger className="w-full md:w-48">
                  <Filter className="h-4 w-4 mr-2" />
                  <SelectValue placeholder="Filter by type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Files</SelectItem>
                  <SelectItem value="pdf">PDF Files</SelectItem>
                  <SelectItem value="doc">Word Documents</SelectItem>
                  <SelectItem value="txt">Text Files</SelectItem>
                  <SelectItem value="ai review">AI Reviews</SelectItem>
                  <SelectItem value="upload">Uploaded Files</SelectItem>
                </SelectContent>
              </Select>
              <Button onClick={forceRefresh} variant="outline" className="gap-2">
                <Download className="h-4 w-4" />
                Refresh
              </Button>
            </div>


            {/* Documents Grid */}
            {isLoading ? (
              <div className="text-center py-8">
                <p className="text-muted-foreground">Loading documents...</p>
              </div>
            ) : filteredDocuments?.length === 0 ? (
              <div className="text-center py-8">
                <Upload className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
                <p className="text-muted-foreground mb-2">
                  {searchTerm || filterType !== 'all' ? 'No documents match your search' : 'No documents uploaded yet'}
                </p>
                <p className="text-sm text-muted-foreground">
                  Upload your first document using the form above
                </p>
              </div>
            ) : (
              <div className="grid gap-4">
                {filteredDocuments?.map((doc) => {
                  // Special rendering for AI Analysis documents
                  if (doc.category === 'AI Analysis') {
                    return (
                      <Card key={doc.id} className="overflow-hidden transition-all duration-200 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-4">
                              <div className="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg">
                                <FileText className="h-5 w-5 text-blue-600 dark:text-blue-400" />
                              </div>
                              <div>
                                <h3 className="font-semibold text-gray-900 dark:text-gray-100">Document Review</h3>
                                <p className="text-sm text-gray-600 dark:text-gray-400">
                                  IEP Document Review ‚Ä¢ {format(new Date(doc.created_at || ''), 'M/d/yyyy')}
                                </p>
                              </div>
                            </div>
                            <div className="flex items-center gap-2">
                              <Badge className="bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-100 hover:bg-orange-100">
                                AI Analysis
                              </Badge>
                              <span className="text-sm text-gray-600 dark:text-gray-400">
                                {format(new Date(doc.created_at || ''), 'MMM d, yyyy')}
                              </span>
                              <span className="text-xs text-gray-500 dark:text-gray-500">
                                {format(new Date(doc.created_at || ''), 'h:mm a')}
                              </span>
                            </div>
                          </div>

                          <div className="flex items-center gap-2 mb-4">
                            <Badge variant="secondary" className="bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-100">
                              IEP
                            </Badge>
                            <Badge variant="outline" className="text-orange-600 border-orange-300">
                              Medium Priority
                            </Badge>
                            <Badge variant="outline" className="text-orange-600 border-orange-300">
                              75% Compliant
                            </Badge>
                          </div>

                          <div className="flex items-center gap-2">
                            <Button
                              className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white"
                              size="sm"
                              onClick={() => handleViewDocument(doc)}
                            >
                              <Eye className="h-4 w-4" />
                              View
                            </Button>
                            <Button
                              variant="outline"
                              className="flex items-center gap-2"
                              size="sm"
                              onClick={() => handleDownloadDocument(doc)}
                            >
                              <Download className="h-4 w-4" />
                              Download
                            </Button>
                            <Button
                              variant="destructive"
                              className="flex items-center gap-2"
                              size="sm"
                              onClick={() => handleDeleteDocument(doc.id, doc.title)}
                            >
                              <Trash2 className="h-4 w-4" />
                              Delete
                            </Button>
                          </div>
                        </CardContent>
                      </Card>
                    );
                  }

                  // Regular document rendering for non-AI Analysis documents
                  return (
                    <div key={doc.id} className="flex items-center justify-between p-4 bg-muted/50 rounded-lg hover:bg-muted/70 transition-colors">
                      <div className="flex items-center gap-4">
                        <div className="text-2xl">{getFileTypeIcon(doc.file_type || '')}</div>
                        <div>
                          {editingDocument?.id === doc.id ? (
                            <div className="flex items-center gap-2 mb-2">
                              <Input
                                value={newFileName}
                                onChange={(e) => setNewFileName(e.target.value)}
                                className="h-8 text-sm font-medium"
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    handleUpdateFileName();
                                  } else if (e.key === 'Escape') {
                                    handleCancelEdit();
                                  }
                                }}
                                autoFocus
                                data-testid={`input-edit-filename-${doc.id}`}
                              />
                              <Button
                                size="sm"
                                variant="ghost"
                                className="h-8 w-8 p-0 text-green-600 hover:text-green-700 hover:bg-green-50"
                                onClick={handleUpdateFileName}
                                data-testid={`button-save-filename-${doc.id}`}
                              >
                                <Check className="h-4 w-4" />
                              </Button>
                              <Button
                                size="sm"
                                variant="ghost"
                                className="h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50"
                                onClick={handleCancelEdit}
                                data-testid={`button-cancel-filename-${doc.id}`}
                              >
                                <X className="h-4 w-4" />
                              </Button>
                            </div>
                          ) : (
                            <div className="flex items-center gap-2 group">
                              <h4 className="font-medium">{doc.title}</h4>
                              <Button
                                size="sm"
                                variant="ghost"
                                className="h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity"
                                onClick={() => handleEditFileName(doc.id, doc.title)}
                                data-testid={`button-edit-filename-${doc.id}`}
                              >
                                <Edit className="h-3 w-3" />
                              </Button>
                            </div>
                          )}
                          <div className="flex items-center gap-4 text-sm text-muted-foreground">
                            <span>{doc.file_name}</span>
                            <span>{doc.file_size ? formatFileSize(doc.file_size) : 'Unknown size'}</span>
                            <div className="flex flex-col gap-1">
                              <span className="flex items-center gap-1">
                                <Calendar className="h-3 w-3" />
                                {format(new Date(doc.created_at || ''), 'MMM d, yyyy')}
                              </span>
                              <span className="flex items-center gap-1 text-xs text-muted-foreground">
                                <Clock className="h-3 w-3" />
                                {format(new Date(doc.created_at || ''), 'h:mm a')}
                              </span>
                            </div>
                          </div>
                          <div className="flex items-center gap-2 mt-1 flex-wrap">
                            {doc.student_id && (() => {
                              const student = students?.find(s => s.id === doc.student_id);
                              return student ? (
                                <Badge variant="outline" className="text-xs">
                                  Student: {student.full_name}
                                </Badge>
                              ) : null;
                            })()}
                            {doc.category && (
                              <Badge variant="secondary" className="text-xs">
                                {doc.category}
                              </Badge>
                            )}
                          </div>
                          {doc.description && (
                            <p className="text-sm text-muted-foreground mt-1">{doc.description}</p>
                          )}
                        </div>
                      </div>
                        <div className="flex items-center gap-2">
                          {doc.confidential && (
                            <Badge variant="secondary" className="text-xs">
                              <Shield className="h-3 w-3 mr-1" />
                              Confidential
                            </Badge>
                          )}
                          
                          {/* Primary Actions - Always Visible */}
                          <Button 
                            size="sm" 
                            variant="outline" 
                            className="h-8"
                            onClick={() => handleViewDocument(doc)}
                            data-testid={`button-view-${doc.id}`}
                          >
                            <Eye className="h-4 w-4 mr-1" />
                            View
                          </Button>
                          <Button 
                            size="sm" 
                            variant="outline" 
                            className="h-8"
                            onClick={() => handleDownloadDocument(doc)}
                            data-testid={`button-download-${doc.id}`}
                          >
                            <Download className="h-4 w-4 mr-1" />
                            Download
                          </Button>

                          {/* Secondary Actions - Dropdown Menu */}
                          <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                              <Button variant="outline" size="sm" className="h-8 w-8 p-0">
                                <MoreVertical className="h-4 w-4" />
                              </Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent align="end" className="w-48">
                              <DropdownMenuItem 
                                onClick={() => handleEditFileName(doc.id, doc.title)}
                                data-testid={`menu-edit-filename-${doc.id}`}
                              >
                                <Edit className="h-4 w-4 mr-2" />
                                Edit Name
                              </DropdownMenuItem>
                              <DropdownMenuItem 
                                onClick={() => handleAssignToStudent(doc.id)}
                                data-testid={`menu-assign-student-${doc.id}`}
                              >
                                <User className="h-4 w-4 mr-2" />
                                Assign Student
                              </DropdownMenuItem>
                              <DropdownMenuItem 
                                onClick={() => handleShareDocument(doc)}
                                data-testid={`menu-share-${doc.id}`}
                              >
                                <Share className="h-4 w-4 mr-2" />
                                Share
                              </DropdownMenuItem>
                              <DropdownMenuSeparator />
                              <DropdownMenuItem 
                                onClick={() => handleDeleteDocument(doc.id, doc.file_name)}
                                className="text-destructive focus:text-destructive focus:bg-destructive/10"
                                data-testid={`menu-delete-${doc.id}`}
                              >
                                <Trash2 className="h-4 w-4 mr-2" />
                                Delete
                              </DropdownMenuItem>
                            </DropdownMenuContent>
                          </DropdownMenu>

                          {/* Student Assignment Dialog */}
                          <Dialog open={assigningDocument === doc.id} onOpenChange={(open) => !open && setAssigningDocument(null)}>
                            <DialogContent className="sm:max-w-[425px]">
                              <DialogHeader>
                                <DialogTitle>Assign Student</DialogTitle>
                                <DialogDescription>
                                  Select a student to assign this document to: {doc.title}
                                </DialogDescription>
                              </DialogHeader>
                              <div className="grid gap-4 py-4">
                                <div className="grid gap-2">
                                  <Label htmlFor="student-select">Student</Label>
                                  <Select value={selectedStudentId} onValueChange={setSelectedStudentId}>
                                    <SelectTrigger>
                                      <SelectValue placeholder="Select a student..." />
                                    </SelectTrigger>
                                    <SelectContent>
                                      {students?.map((student) => (
                                        <SelectItem key={student.id} value={student.id}>
                                          {student.full_name}
                                        </SelectItem>
                                      ))}
                                    </SelectContent>
                                  </Select>
                                </div>
                              </div>
                              <DialogFooter>
                                <Button type="button" variant="outline" onClick={() => setAssigningDocument(null)}>
                                  Cancel
                                </Button>
                                <Button type="button" onClick={handleUpdateStudentAssignment} disabled={!selectedStudentId}>
                                  Assign Student
                                </Button>
                              </DialogFooter>
                            </DialogContent>
                          </Dialog>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  );
};

export default DocumentVault;
